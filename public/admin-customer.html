<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Kundprofil - Source Admin Portal</title>
  <meta name="description" content="Detaljerad kundprofil med ärenden och chattmeddelanden i Source Admin Portal" />
  <link rel="stylesheet" href="/css/admin-customer.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <nav aria-label="Breadcrumb">
      <a href="/dashboard" class="back-link">← Tillbaka till dashboard</a>
    </nav>

    <main class="customer-profile" aria-labelledby="customer-heading">
      <article class="card customer-info" aria-labelledby="customer-info-heading">
        <div class="customer-header">
          <div class="customer-title-section">
            <h1 id="customer-info-heading">Kundinformation</h1>
            <h2 id="customer-heading">Laddar kund...</h2>
          </div>
          <div class="customer-actions">
            <button id="impersonateBtn" class="impersonate-btn" disabled>
              <span class="btn-icon">👤</span>
              <span class="btn-text">Impersonera Kund</span>
            </button>
          </div>
        </div>
        
        <div class="customer-details-grid">
          <div class="detail-card">
            <div class="detail-icon">📧</div>
            <div class="detail-content">
              <label class="detail-label">E-post</label>
              <div id="email" class="detail-value">-</div>
            </div>
          </div>
          
          <div class="detail-card">
            <div class="detail-icon">🆔</div>
            <div class="detail-content">
              <label class="detail-label">Kund-ID</label>
              <div id="customerId" class="detail-value">-</div>
            </div>
          </div>
          
          <div class="detail-card">
            <div class="detail-icon">🕒</div>
            <div class="detail-content">
              <label class="detail-label">Skapad</label>
              <div id="createdAt" class="detail-value">-</div>
            </div>
          </div>
          
          <div class="detail-card">
            <div class="detail-icon">🏷️</div>
            <div class="detail-content">
              <label class="detail-label">Kampanj</label>
              <div id="campaigns" class="detail-value">-</div>
            </div>
          </div>
          
          <div class="detail-card">
            <div class="detail-icon">🏭</div>
            <div class="detail-content">
              <label class="detail-label">Bransch</label>
              <div id="industry" class="detail-value">-</div>
            </div>
          </div>
          
          <div class="detail-card">
            <div class="detail-icon">🌐</div>
            <div class="detail-content">
              <label class="detail-label">Webbplats</label>
              <div id="website" class="detail-value">-</div>
            </div>
          </div>
        </div>
      </article>

      <section class="card cases-section" aria-labelledby="cases-heading">
        <h2 id="cases-heading">📂 Relaterade Ärenden</h2>
        <div id="casesContainer" role="list" aria-live="polite" aria-label="Kundens ärenden">Laddar ärenden...</div>
      </section>

      <section class="card chat-section" aria-labelledby="chat-heading">
        <h2 id="chat-heading">💬 Livechat-meddelanden</h2>
        <div id="chatMessagesAdmin" role="log" aria-live="polite" aria-label="Chattmeddelanden">Laddar meddelanden...</div>
      </section>
    </main>
  </div>

  <script>
    const id = new URLSearchParams(window.location.search).get("id");
    let customerData = null;

    if (!id) {
      document.body.innerHTML = "<p>Kund-ID saknas.</p>";
    } else {
      // 🔹 Hämta kunddata
      fetch(`/api/customers/by-id/${id}`)
        .then(res => res.json())
        .then(data => {
          customerData = data;
          document.getElementById("customer-heading").textContent = data.name || "Okänd kund";
          document.getElementById("email").textContent = data.email || "-";
          document.getElementById("customerId").textContent = data._id || "-";
          document.getElementById("createdAt").textContent = data.createdAt 
            ? new Date(data.createdAt).toLocaleString("sv-SE") 
            : "-";
          document.getElementById("campaigns").textContent = data.campaigns || "-";
          document.getElementById("industry").textContent = data.industry || "-";
          document.getElementById("website").innerHTML = data.website 
            ? `<a href="${data.website}" target="_blank" rel="noopener" class="website-link">${data.website}</a>` 
            : "-";
          
          // Enable impersonate button
          const impersonateBtn = document.getElementById("impersonateBtn");
          impersonateBtn.disabled = false;
          impersonateBtn.addEventListener("click", handleImpersonate);
        })
        .catch(err => {
          console.error("❌ Kunde inte hämta kundinfo:", err);
          document.querySelector(".container").innerHTML = "<p style='color:red;'>Fel vid hämtning av kunddata.</p>";
        });

      // 🔹 Impersonate functionality
      function handleImpersonate() {
        if (!customerData) {
          alert("Kunddata inte tillgänglig");
          return;
        }

        const confirmMessage = `Är du säker på att du vill impersonera kunden "${customerData.name || 'Okänd kund'}"?\n\nDetta ger dig full åtkomst till deras kundportal.`;
        
        if (confirm(confirmMessage)) {
          // Show loading state
          const btn = document.getElementById("impersonateBtn");
          const originalText = btn.innerHTML;
          btn.innerHTML = '<span class="btn-icon">⏳</span><span class="btn-text">Impersonerar...</span>';
          btn.disabled = true;

          // Call impersonate API
          fetch('/api/admin/impersonate', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({
              customerId: id,
              customerEmail: customerData.email
            })
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              // Redirect to customer portal with impersonation token
              window.open(data.redirectUrl, '_blank');
              btn.innerHTML = originalText;
              btn.disabled = false;
            } else {
              alert('Fel vid impersonation: ' + (data.message || 'Okänt fel'));
              btn.innerHTML = originalText;
              btn.disabled = false;
            }
          })
          .catch(err => {
            console.error('❌ Impersonation error:', err);
            alert('Fel vid impersonation. Försök igen.');
            btn.innerHTML = originalText;
            btn.disabled = false;
          });
        }
      }

      // 🔹 Hämta kundens ärenden (cases)
      fetch(`/api/cases/customer/${id}`)
        .then(res => res.json())
        .then(cases => {
          const container = document.getElementById("casesContainer");
          if (!cases.length) {
            container.innerHTML = "<p>Inga ärenden hittades.</p>";
            return;
          }

          container.innerHTML = cases.map(c => `
            <div class="case-card">
              <p><strong>📌 Case ID:</strong> ${c.caseId || "–"}</p>
              <p><strong>📝 Ämne:</strong> ${c.topic || "–"}</p>
              <p><strong>📄 Beskrivning:</strong> ${c.description || "–"}</p>
              <p><strong>📅 Skapad:</strong> ${new Date(c.createdAt).toLocaleString("sv-SE")}</p>
            </div>
          `).join("");
        })
        .catch(err => {
          console.error("❌ Kunde inte hämta ärenden:", err);
          document.getElementById("casesContainer").innerHTML = "<p style='color:red;'>Fel vid hämtning av ärenden.</p>";
        });

      // 🔹 Hämta chattmeddelanden
      fetch(`/api/chat/customer/${id}`)
        .then(res => res.json())
        .then(messages => {
          const container = document.getElementById("chatMessagesAdmin");
          if (!messages.length) {
            container.innerHTML = "<p>Inga meddelanden hittades.</p>";
            return;
          }

          container.innerHTML = messages.map(msg => `
            <div class="chat-message">
              <div class="sender">${msg.sender === "customer" ? "👤 Kund" : "🛠️ Admin"}:</div>
              <div>${msg.message}</div>
              <div class="timestamp">${new Date(msg.timestamp).toLocaleString("sv-SE")}</div>
            </div>
          `).join("");
        })
        .catch(err => {
          console.error("❌ Kunde inte hämta meddelanden:", err);
          document.getElementById("chatMessagesAdmin").innerHTML = "<p style='color:red;'>Fel vid hämtning av chatt.</p>";
        });
    }
  </script>
</body>
</html>
