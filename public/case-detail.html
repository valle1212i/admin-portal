<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Ärendedetaljer - Source Admin Portal</title>
  <meta name="description" content="Detaljerad vy över supportärende med chattranskript och hanteringsverktyg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/css/dashboard.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <header class="status-bar" aria-labelledby="status-heading">
      <h1 id="status-heading" class="sr-only">Ärende status</h1>
      <div class="status-buttons" role="group" aria-label="Välj ärende status">
        <button class="status-btn btn-secondary" data-status="Nytt" aria-pressed="false">🗂️ Nytt</button>
        <button class="status-btn btn-secondary" data-status="Arbetande" aria-pressed="false">🛠️ Arbetande</button>
        <button class="status-btn btn-secondary" data-status="Väntar svar" aria-pressed="false">⏳ Väntar svar</button>
        <button class="status-btn btn-secondary" data-status="On Hold" aria-pressed="false">🛑 On Hold</button>
        <button class="status-btn btn-secondary" data-status="open" aria-pressed="false">📂 Öppen</button>
        <button class="status-btn btn-secondary" data-status="Stängt" aria-pressed="false">✅ Stängt</button>
      </div>
      <button id="update-status-btn" class="btn-primary">📁 Bekräfta status</button>
    </header>

    <main class="case-detail-main">
      <div class="section">
        <article class="card case-info" aria-labelledby="case-info-heading">
          <h2 id="case-info-heading">📄 Ärendeinfo</h2>
          
          <dl class="case-details">
            <div class="detail-item">
              <dt>ID:</dt>
              <dd id="case-id">Laddar...</dd>
            </div>
            <div class="detail-item">
              <dt>Kund:</dt>
              <dd id="customer-name">Laddar...</dd>
            </div>
            <div class="detail-item">
              <dt>Typ:</dt>
              <dd id="case-type">Laddar...</dd>
            </div>
            <div class="detail-item">
              <dt>Beskrivning:</dt>
              <dd id="case-description">Laddar...</dd>
            </div>
            <div class="detail-item">
              <dt>Skapad:</dt>
              <dd id="created-at">Laddar...</dd>
            </div>
          </dl>

          <div class="admin-assignment">
            <label for="admin-display">🧑‍💼 Ansvarig admin:</label>
            <div class="readonly-box">
              <input type="text" id="admin-display" readonly aria-label="Tilldelad admin" />
              <button type="button" class="edit-icon" onclick="toggleEditAdmin()" aria-label="Redigera admin tilldelning">✏️</button>
            </div>
            <input type="text" id="admin-input" style="display: none;" placeholder="Sök admin..." oninput="filterAdmins(this.value)" list="admin-suggestions" aria-label="Sök och välj admin" />
            <datalist id="admin-suggestions"></datalist>
          </div>

          <section class="note-section" aria-labelledby="notes-heading">
            <h3 id="notes-heading">📝 Intern anteckning</h3>
            <label for="internal-note" class="sr-only">Skriv intern anteckning</label>
            <textarea id="internal-note" placeholder="Skriv en intern anteckning..." aria-describedby="note-help"></textarea>
            <div id="note-help" class="sr-only">Skriv interna anteckningar som bara admin kan se</div>
            <button type="button" class="btn-primary" onclick="saveNote()">💾 Spara anteckning</button>

            <div class="note-list" id="note-list" role="list" aria-label="Interna anteckningar"></div>
          </section>

          <section class="message-section" aria-labelledby="message-heading">
            <h3 id="message-heading">📨 Skicka meddelande till kund</h3>
            <label for="customer-message" class="sr-only">Skriv meddelande till kund</label>
            <textarea id="customer-message" placeholder="Skriv meddelande till kund..." aria-describedby="message-help"></textarea>
            <div id="message-help" class="sr-only">Skriv ett meddelande som skickas till kunden</div>
            <button type="button" class="btn-primary" onclick="sendMessage()">📤 Skicka</button>
          </section>
        </article>

        <article class="card chat-transcript" aria-labelledby="transcript-heading">
          <h2 id="transcript-heading">💬 Chatttranskript</h2>
          <div id="chat-transcript" role="log" aria-live="polite" aria-label="Chattmeddelanden">Laddar...</div>
        </article>
      </div>
    </main>
  </div>

  <style>
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .status-bar {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      max-width: 1400px;
      margin-bottom: var(--space-8);
      padding: var(--space-6);
      background: white;
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--gray-200);
    }

    .status-buttons {
      display: flex;
      flex-direction: row;
      gap: var(--space-3);
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: var(--space-4);
    }

    .status-btn {
      padding: var(--space-3) var(--space-4);
      border-radius: var(--radius-lg);
      font-weight: var(--font-weight-medium);
      cursor: pointer;
      transition: all var(--transition-fast);
      border: 2px solid var(--gray-300);
    }

    .status-btn:hover {
      background: var(--gray-100);
      border-color: var(--gray-400);
    }

    .status-btn.active {
      background-color: var(--primary-600);
      color: white;
      border-color: var(--primary-600);
    }

    .case-detail-main {
      width: 100%;
      max-width: 1400px;
    }

    .case-details {
      display: grid;
      gap: var(--space-3);
      margin-bottom: var(--space-6);
    }

    .detail-item {
      display: flex;
      align-items: flex-start;
      gap: var(--space-4);
    }

    .detail-item dt {
      font-weight: var(--font-weight-semibold);
      color: var(--gray-700);
      min-width: 120px;
    }

    .detail-item dd {
      margin: 0;
      flex: 1;
      color: var(--gray-600);
    }

    .admin-assignment {
      margin-bottom: var(--space-6);
    }

    .readonly-box {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      background: var(--gray-100);
      padding: var(--space-3);
      border-radius: var(--radius-lg);
      margin-top: var(--space-2);
    }

    .readonly-box input {
      margin: 0;
      background: transparent;
      border: none;
    }

    .edit-icon {
      cursor: pointer;
      font-size: var(--font-size-lg);
      color: var(--gray-600);
      transition: color var(--transition-fast);
    }

    .edit-icon:hover {
      color: var(--primary-600);
    }

    .note-section, .message-section {
      margin-top: var(--space-6);
      padding-top: var(--space-6);
      border-top: 1px solid var(--gray-200);
    }

    .note-list {
      margin-top: var(--space-4);
    }

    .note-item {
      background: var(--gray-50);
      padding: var(--space-4);
      border-radius: var(--radius-lg);
      margin-top: var(--space-3);
      border-left: 4px solid var(--primary-500);
    }

    .note-item small {
      display: block;
      color: var(--gray-500);
      margin-top: var(--space-2);
      font-size: var(--font-size-sm);
    }

    .message {
      margin-bottom: var(--space-4);
      padding: var(--space-4);
      border-radius: var(--radius-lg);
      font-size: var(--font-size-sm);
    }

    .message.admin {
      background: var(--primary-50);
      border-left: 4px solid var(--primary-500);
    }

    .message.system {
      background: var(--warning-50);
      border-left: 4px solid var(--warning-500);
    }

    .message.customer {
      background: #f0f7ff;
      border-left: 4px solid #0066cc;
    }

    .message-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-2);
      font-size: var(--font-size-sm);
    }

    .message-header strong {
      color: var(--gray-800);
    }

    .message-time {
      color: var(--gray-500);
      font-size: var(--font-size-xs);
      font-weight: normal;
    }

    .message-content {
      color: var(--gray-700);
      line-height: 1.5;
    }

    @media (max-width: 1024px) {
      .case-detail-main .section {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .status-buttons {
        flex-direction: column;
        align-items: stretch;
      }
      
      .detail-item {
        flex-direction: column;
        gap: var(--space-1);
      }
      
      .detail-item dt {
        min-width: auto;
      }
    }
  </style>

<script>
  const sessionId = new URLSearchParams(window.location.search).get("sessionId");
  let currentAdmins = [];
  let editingAdmin = false;

  async function loadCaseData() {
    const res = await fetch(`/api/cases/meta/${sessionId}`);
    const data = await res.json();

    document.getElementById("case-id").textContent = data._id;
    document.getElementById("customer-name").textContent = data.customerName || "Okänd";
    document.getElementById("case-type").textContent = data.topic || "-";
    document.getElementById("case-description").textContent = data.description || "-";
    document.getElementById("created-at").textContent = new Date(data.createdAt).toLocaleString("sv-SE");
    document.getElementById("admin-display").value = data.assignedAdminName || "Ingen";

    const btn = document.querySelector(`.status-buttons button[data-status="${data.status}"]`);
    if (btn) btn.classList.add("active");

    const transcript = document.getElementById("chat-transcript");
    transcript.innerHTML = (data.messages || []).map(msg => {
      const messageClass = msg.sender === 'customer' ? 'customer' : 
                          msg.sender === 'system' ? 'system' : 'admin';
      const senderDisplay = msg.senderName || msg.sender;
      const senderEmail = msg.senderEmail ? ` (${msg.senderEmail})` : '';
      
      return `
        <div class="message ${messageClass}">
          <div class="message-header">
            <strong>${senderDisplay}${senderEmail}</strong>
            <span class="message-time">${new Date(msg.timestamp).toLocaleString("sv-SE")}</span>
          </div>
          <div class="message-content">${msg.message}</div>
        </div>
      `;
    }).join("");

      const noteList = document.getElementById("note-list");
noteList.innerHTML = (data.internalNotes || []).map(n => `
  <div class="note-item">
    ${n.note}
    <small>🕒 ${new Date(n.timestamp || Date.now()).toLocaleString("sv-SE")}</small>
  </div>
`).join("");
  }

  async function loadAdmins() {
    const res = await fetch("/api/admins");
    currentAdmins = await res.json();
  }

  function toggleEditAdmin() {
    if (!editingAdmin) {
      document.getElementById("admin-display").style.display = "none";
      document.getElementById("admin-input").style.display = "block";
      editingAdmin = true;
    } else {
      const name = document.getElementById("admin-input").value;
      const match = currentAdmins.find(a => a.name.toLowerCase() === name.toLowerCase());
      if (match) {
        fetch("/api/cases/assign-admin", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ sessionId, adminId: match._id })
        }).then(() => {
          document.getElementById("admin-display").value = match.name;
          document.getElementById("admin-display").style.display = "block";
          document.getElementById("admin-input").style.display = "none";
          editingAdmin = false;
        });
      }
    }
  }

  function filterAdmins(value) {
    const datalist = document.getElementById("admin-suggestions");
    datalist.innerHTML = "";
    currentAdmins
      .filter(a => a.name.toLowerCase().includes(value.toLowerCase()))
      .forEach(a => {
        const option = document.createElement("option");
        option.value = a.name;
        datalist.appendChild(option);
      });
  }

  function saveNote() {
    const note = document.getElementById("internal-note").value;
    if (!note.trim()) return alert("Ange en anteckning.");
    fetch("/api/cases/add-note", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ sessionId, note })
    })
      .then(res => res.json())
      .then(result => {
        if (result.success) {
          alert("📝 Anteckning sparad.");
          document.getElementById("internal-note").value = "";
          loadCaseData(); // 🔄 Ladda om anteckningar direkt
        } else {
          alert("❌ Kunde inte spara anteckning.");
        }
      });
  }

  function sendMessage() {
    const msg = document.getElementById("customer-message").value;
    if (!msg.trim()) return alert("Ange ett meddelande.");
    fetch("/api/cases/send-message", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ sessionId, message: msg })
    }).then(() => {
      alert("📨 Meddelande skickat.");
      document.getElementById("customer-message").value = "";
      loadCaseData();
    });
  }

  document.querySelectorAll(".status-buttons button").forEach(button => {
    button.addEventListener("click", () => {
      document.querySelectorAll(".status-buttons button").forEach(b => b.classList.remove("active"));
      button.classList.add("active");
    });
  });

  document.getElementById("update-status-btn").addEventListener("click", () => {
    const activeBtn = document.querySelector(".status-buttons button.active");
    if (!activeBtn) return alert("Välj en status först.");
    fetch("/api/cases/update-status", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ sessionId, status: activeBtn.dataset.status })
    }).then(() => alert("✅ Status uppdaterad!"));
  });

  loadCaseData();
  loadAdmins();
</script>
</body>
</html>
