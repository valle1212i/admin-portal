<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>√Ñrendedetaljer</title>
  <link rel="stylesheet" href="/css/cases.css" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
    }

    .wrapper {
      display: flex;
      flex-wrap: wrap;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .sidebar {
      flex: 1 1 300px;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      margin-right: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      min-width: 250px;
    }

    .main-content {
      flex: 3 1 600px;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      min-width: 300px;
    }

    h2 {
      margin-top: 0;
    }

    select, textarea, button {
      width: 100%;
      margin: 8px 0;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }

    .transcript-box {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 20px;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 10px;
      background-color: #fefefe;
    }

    .chat-bubble {
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
    }

    .chat-bubble.admin { background: #d1e7ff; }
    .chat-bubble.customer { background: #e2ffe8; }
    .chat-bubble.system { background: #fff3cd; }

    .chat-meta {
      font-size: 0.8rem;
      color: #666;
      margin-top: 4px;
    }

    button.danger { background-color: #dc3545; color: white; }
    button.primary { background-color: #007bff; color: white; }
  </style>
</head>
<body>
  <div class="wrapper">
    <!-- SIDEBAR -->
    <div class="sidebar">
      <h2>üóÇ √Ñrendeinfo</h2>
      <div id="caseMeta"></div>

      <label for="adminSelect">üë©‚Äçüíº Ansvarig admin</label>
      <select id="adminSelect">
        <option value="">V√§lj admin...</option>
        <option value="admin1">Anna Andersson</option>
        <option value="admin2">Erik Eriksson</option>
      </select>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
      <h2>üí¨ Chattranskript</h2>
      <div id="chatTranscript" class="transcript-box"></div>

      <h3>üìù L√§gg till intern anteckning</h3>
      <textarea id="internalNote" placeholder="Skriv anteckning..."></textarea>
      <button class="primary" id="saveNoteBtn">Spara anteckning</button>

      <h3>üìß Skicka e-post till kund</h3>
      <textarea id="emailContent" placeholder="Skriv meddelande..."></textarea>
      <button class="primary" id="sendEmailBtn">Skicka mejl</button>
      <button class="danger" id="closeCaseBtn">Avsluta √§rende</button>
    </div>
  </div>

  <script>
    const sessionId = new URLSearchParams(window.location.search).get("sessionId");
    let customerId = null;

    async function loadCase() {
      try {
        const metaRes = await fetch(`/api/cases/meta/${sessionId}`);
        const info = await metaRes.json();
        customerId = info.customerId;

        document.getElementById("caseMeta").innerHTML = `
          <p><strong>ID:</strong> ${info.sessionId}</p>
          <p><strong>Kund:</strong> ${info.customerName}</p>
          <p><strong>Typ:</strong> ${info.topic}</p>
          <p><strong>Beskrivning:</strong><br>${info.description}</p>
          <p><strong>Skapad:</strong> ${new Date(info.createdAt).toLocaleString("sv-SE")}</p>
        `;

        if (info.assignedAdmin) {
  document.getElementById("adminSelect").value = info.assignedAdmin;
}

        const chatRes = await fetch(`/api/chat/session/${sessionId}`);
        const messages = await chatRes.json();

        const transcript = document.getElementById("chatTranscript");
        transcript.innerHTML = "";
        messages.forEach(msg => {
          const div = document.createElement("div");
          const type =
            msg.sender === "admin" ? "admin" :
            msg.sender === "system" ? "system" : "customer";
          div.className = `chat-bubble ${type}`;
          div.innerHTML = `
            <strong>${type === 'admin' ? 'üë©‚Äçüíª Admin' : type === 'system' ? '‚öôÔ∏è System' : 'üë§ Kund'}</strong><br/>
            ${msg.message}
            <div class="chat-meta">${new Date(msg.timestamp).toLocaleString("sv-SE")}</div>
          `;
          transcript.appendChild(div);
        });
      } catch (err) {
        alert("Kunde inte ladda √§rendet.");
        console.error(err);
      }
    }

    document.getElementById("saveNoteBtn").addEventListener("click", async () => {
      const note = document.getElementById("internalNote").value.trim();
      if (!note) return alert("F√§ltet √§r tomt.");
      await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          sessionId,
          customerId,
          message: `üìù INTERN ANTECKNING: ${note}`,
          sender: "system",
          timestamp: new Date()
        })
      });
      location.reload();
    });

    document.getElementById("sendEmailBtn").addEventListener("click", async () => {
      const content = document.getElementById("emailContent").value.trim();
      if (!content) return alert("Skriv n√•got f√∂rst.");
      await fetch("/api/email/send", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ customerId, sessionId, subject: `Svar p√• √§rende #${sessionId}`, message: content })
      });
      await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          sessionId,
          customerId,
          message: `üì¨ Mejlsvar till kund: "${content}"`,
          sender: "system",
          timestamp: new Date()
        })
      });
      location.reload();
    });

    document.getElementById("closeCaseBtn").addEventListener("click", async () => {
      if (!confirm("Avsluta detta √§rende?")) return;
      await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          sessionId,
          customerId,
          message: "‚úÖ √Ñrendet har markerats som avslutat.",
          sender: "system",
          timestamp: new Date()
        })
      });
      await fetch("/api/email/send", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          customerId,
          sessionId,
          subject: `√Ñrende #${sessionId} avslutat`,
          message: `Ditt √§rende #${sessionId} √§r nu avslutat. Tack f√∂r att du kontaktade oss!`
        })
      });
      alert("√Ñrendet avslutat och kund informerades.");
      location.reload();
    });

    loadCase();
    document.getElementById("adminSelect").addEventListener("change", async (e) => {
  const assignedAdmin = e.target.value;
  if (!assignedAdmin) return;

  try {
    const res = await fetch(`/api/cases/assign-admin/${sessionId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ assignedAdmin })
    });

    if (!res.ok) {
      const err = await res.json();
      alert("Kunde inte spara admin: " + err.message);
    } else {
      alert("Ansvarig admin uppdaterad ‚úÖ");
    }
  } catch (err) {
    console.error("‚ùå Fel vid uppdatering av admin:", err);
    alert("N√•got gick fel vid uppdateringen.");
  }
});

  </script>
</body>
</html>
