<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Ärendedetaljer - Source Admin Portal</title>
  <meta name="description" content="Detaljerad vy över supportärende med chattranskript och hanteringsverktyg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/css/dashboard.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="case-detail-container">
    <!-- Left Sidebar: Customer Context & Quick Actions -->
    <aside class="case-sidebar">
      <!-- Customer Info Card -->
      <div class="customer-card">
        <h3>👤 Kundinformation</h3>
        <div class="customer-details">
          <div class="customer-avatar" id="customer-avatar">EW</div>
          <div class="customer-info">
            <h4 id="customer-name">Laddar...</h4>
            <p id="customer-email">Laddar...</p>
            <span class="customer-id" id="customer-id">ID: Laddar...</span>
          </div>
        </div>
      </div>
      
      <!-- SLA Timer -->
      <div class="sla-timer">
        <h4>⏱️ SLA Status</h4>
        <div class="sla-info">
          <div class="sla-item">
            <span class="sla-label">Svarstid:</span>
            <span class="sla-value" id="response-time">2 timmar</span>
          </div>
          <div class="sla-item">
            <span class="sla-label">Återstående:</span>
            <span class="sla-value" id="response-remaining">1h 23m</span>
          </div>
          <div class="sla-item">
            <span class="sla-label">Status:</span>
            <span class="sla-status on-track" id="sla-status">På rätt väg</span>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="quick-actions">
        <button class="btn-primary" id="call-customer-btn">📞 Ring kund</button>
        <button class="btn-secondary" id="email-customer-btn">📧 Skicka e-post</button>
        <button class="btn-secondary" id="view-profile-btn">👤 Visa profil</button>
      </div>
      
      <!-- Case Timeline -->
      <div class="case-timeline">
        <h4>📅 Tidslinje</h4>
        <div id="timeline-container">
          <div class="timeline-item">
            <span class="timeline-dot created"></span>
            <div class="timeline-content">
              <strong>Ärende skapat</strong>
              <span id="case-created-time">Laddar...</span>
            </div>
          </div>
          <div class="timeline-item">
            <span class="timeline-dot activity"></span>
            <div class="timeline-content">
              <strong>Senaste aktivitet</strong>
              <span id="last-activity-time">Laddar...</span>
            </div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Content Area -->
    <main class="case-main">
      <!-- Status Section -->
      <div class="status-section">
        <div class="case-header">
          <div class="case-title">
            <h1 id="case-title">Laddar...</h1>
            <div class="case-meta">
              <span class="case-type" id="case-type-display">📝 Test</span>
              <span class="case-priority high">🔴 Hög prioritet</span>
            </div>
          </div>
          <div class="case-id-display">
            <span class="case-id-label">Ärende ID:</span>
            <code id="case-id-code">Laddar...</code>
          </div>
        </div>
        
        <div class="status-controls">
          <div class="status-buttons" role="group" aria-label="Välj ärende status">
            <button class="status-btn btn-secondary" data-status="Nytt" aria-pressed="false">🗂️ Nytt</button>
            <button class="status-btn btn-secondary" data-status="Arbetande" aria-pressed="false">🛠️ Arbetande</button>
            <button class="status-btn btn-secondary" data-status="Väntar svar" aria-pressed="false">⏳ Väntar svar</button>
            <button class="status-btn btn-secondary" data-status="On Hold" aria-pressed="false">🛑 On Hold</button>
            <button class="status-btn btn-secondary" data-status="open" aria-pressed="false">📂 Öppen</button>
            <button class="status-btn btn-secondary" data-status="Stängt" aria-pressed="false">✅ Stängt</button>
          </div>
          <div class="status-actions">
            <button id="update-status-btn" class="btn-primary">✅ Bekräfta status</button>
            <button id="add-note-btn" class="btn-secondary">📝 Lägg till anteckning</button>
          </div>
        </div>
      </div>

      <!-- Communication Section -->
      <div class="communication-section">
        <div class="chat-container">
          <div class="chat-header">
            <h3>💬 Konversation</h3>
            <div class="chat-actions">
              <button class="btn-sm" id="search-messages-btn">🔍 Sök</button>
              <button class="btn-sm" id="filter-messages-btn">🔽 Filtrera</button>
              <button class="btn-sm" id="attach-file-btn">📎 Bifoga</button>
            </div>
          </div>
          
          <!-- Chat Messages -->
          <div class="chat-messages" id="chat-transcript">
            <!-- Messages will be populated here -->
          </div>
          
          <!-- Quick Response Templates -->
          <div class="response-templates">
            <h4>📋 Snabbsvar</h4>
            <div class="template-buttons">
              <button class="template-btn" data-template="greeting">"Hej! Tack för att du kontaktar oss..."</button>
              <button class="template-btn" data-template="info-request">"Jag behöver mer information..."</button>
              <button class="template-btn" data-template="resolution">"Problemet är nu löst..."</button>
              <button class="template-btn" data-template="follow-up">"Jag följer upp detta..."</button>
            </div>
          </div>
          
          <!-- Message Input -->
          <div class="message-input">
            <textarea placeholder="Skriv ditt svar här..." id="customer-message"></textarea>
            <div class="input-actions">
              <button class="btn-sm" id="emoji-btn">😊</button>
              <button class="btn-sm" id="format-btn">A</button>
              <button id="send-message-btn" class="btn-primary">📤 Skicka</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Case Details (Collapsible) -->
      <div class="case-details-section">
        <button class="toggle-details-btn" onclick="toggleCaseDetails()">
          <span>📄 Visa ärendedetaljer</span>
          <span class="toggle-icon">▼</span>
        </button>
        
        <div class="case-details-content" id="case-details-content" style="display: none;">
          <article class="card case-info" aria-labelledby="case-info-heading">
            <h2 id="case-info-heading">📄 Ärendeinfo</h2>
          
            <dl class="case-details">
              <div class="detail-item">
                <dt>Beskrivning:</dt>
                <dd id="case-description">Laddar...</dd>
              </div>
              <div class="detail-item">
                <dt>Skapad:</dt>
                <dd id="created-at">Laddar...</dd>
              </div>
            </dl>

            <div class="admin-assignment">
              <label for="admin-display">🧑‍💼 Ansvarig admin:</label>
              <div class="readonly-box">
                <input type="text" id="admin-display" readonly aria-label="Tilldelad admin" />
                <button type="button" class="edit-icon" onclick="toggleEditAdmin()" aria-label="Redigera admin tilldelning">✏️</button>
              </div>
              <input type="text" id="admin-input" style="display: none;" placeholder="Sök admin..." oninput="filterAdmins(this.value)" list="admin-suggestions" aria-label="Sök och välj admin" />
              <datalist id="admin-suggestions"></datalist>
            </div>

            <section class="note-section" aria-labelledby="notes-heading">
              <h3 id="notes-heading">📝 Intern anteckning</h3>
              <label for="internal-note" class="sr-only">Skriv intern anteckning</label>
              <textarea id="internal-note" placeholder="Skriv en intern anteckning..." aria-describedby="note-help"></textarea>
              <div id="note-help" class="sr-only">Skriv interna anteckningar som bara admin kan se</div>
              <button type="button" class="btn-primary" onclick="saveNote()">💾 Spara anteckning</button>

              <div class="note-list" id="note-list" role="list" aria-label="Interna anteckningar"></div>
            </section>
          </article>
        </div>
      </div>
    </main>
  </div>

  <style>
    /* Enhanced Case Detail Styling */
    .case-detail-container {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: var(--space-6);
      min-height: 100vh;
      padding: var(--space-6);
      background: var(--gray-50);
    }

    /* Sidebar Styling */
    .case-sidebar {
      background: white;
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      box-shadow: var(--shadow-lg);
      height: fit-content;
      position: sticky;
      top: var(--space-6);
    }

    .customer-card {
      background: linear-gradient(135deg, var(--primary-50) 0%, var(--primary-100) 100%);
      border-radius: var(--radius-lg);
      padding: var(--space-6);
      margin-bottom: var(--space-6);
      border: 1px solid var(--primary-200);
    }

    .customer-card h3 {
      margin: 0 0 var(--space-4);
      font-size: var(--font-size-lg);
      color: var(--gray-800);
    }

    .customer-details {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .customer-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--primary-600);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: var(--font-size-lg);
      margin-bottom: var(--space-4);
    }

    .customer-info h4 {
      margin: 0 0 var(--space-2);
      font-size: var(--font-size-lg);
      color: var(--gray-900);
    }

    .customer-info p {
      margin: 0 0 var(--space-2);
      color: var(--gray-600);
      font-size: var(--font-size-sm);
    }

    .customer-id {
      font-size: var(--font-size-xs);
      color: var(--gray-500);
      font-family: monospace;
    }

    /* SLA Timer */
    .sla-timer {
      border-top: 1px solid var(--gray-200);
      padding-top: var(--space-4);
      margin-bottom: var(--space-6);
    }

    .sla-timer h4 {
      margin: 0 0 var(--space-3);
      font-size: var(--font-size-base);
      color: var(--gray-800);
    }

    .sla-info {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }

    .sla-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-2);
      background: var(--gray-50);
      border-radius: var(--radius-md);
    }

    .sla-label {
      font-size: var(--font-size-sm);
      color: var(--gray-600);
      font-weight: var(--font-weight-medium);
    }

    .sla-value {
      font-size: var(--font-size-sm);
      color: var(--gray-800);
      font-weight: var(--font-weight-semibold);
    }

    .sla-status {
      font-size: var(--font-size-xs);
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-sm);
      font-weight: var(--font-weight-semibold);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .sla-status.on-track {
      background: var(--success-100);
      color: var(--success-700);
    }

    .sla-status.warning {
      background: var(--warning-100);
      color: var(--warning-700);
    }

    .sla-status.overdue {
      background: var(--error-100);
      color: var(--error-700);
    }

    /* Quick Actions */
    .quick-actions {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
      margin-bottom: var(--space-6);
    }

    .quick-actions button {
      justify-content: flex-start;
      padding: var(--space-3) var(--space-4);
    }

    /* Case Timeline */
    .case-timeline {
      border-top: 1px solid var(--gray-200);
      padding-top: var(--space-4);
    }

    .case-timeline h4 {
      margin: 0 0 var(--space-4);
      font-size: var(--font-size-base);
      color: var(--gray-800);
    }

    .timeline-item {
      display: flex;
      align-items: flex-start;
      gap: var(--space-3);
      margin-bottom: var(--space-4);
    }

    .timeline-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-top: var(--space-2);
      flex-shrink: 0;
      border: 2px solid white;
      box-shadow: 0 0 0 2px var(--gray-300);
    }

    .timeline-dot.created {
      background: var(--success-500);
      box-shadow: 0 0 0 2px var(--success-200);
    }

    .timeline-dot.activity {
      background: var(--primary-500);
      box-shadow: 0 0 0 2px var(--primary-200);
    }

    .timeline-dot.message {
      background: var(--warning-500);
      box-shadow: 0 0 0 2px var(--warning-200);
    }

    .timeline-dot.status {
      background: var(--error-500);
      box-shadow: 0 0 0 2px var(--error-200);
    }

    .timeline-content {
      flex: 1;
    }

    .timeline-content strong {
      display: block;
      font-size: var(--font-size-sm);
      color: var(--gray-800);
      margin-bottom: var(--space-1);
    }

    .timeline-content span {
      font-size: var(--font-size-xs);
      color: var(--gray-500);
    }

    .timeline-description {
      font-size: var(--font-size-xs);
      color: var(--gray-600);
      margin-top: var(--space-1);
      font-style: italic;
    }

    /* Main Content Area */
    .case-main {
      display: flex;
      flex-direction: column;
      gap: var(--space-6);
    }

    /* Status Section */
    .status-section {
      background: white;
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      box-shadow: var(--shadow-lg);
    }

    .case-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--space-6);
      padding-bottom: var(--space-4);
      border-bottom: 1px solid var(--gray-200);
    }

    .case-title h1 {
      font-size: var(--font-size-2xl);
      color: var(--gray-900);
      margin: 0 0 var(--space-2);
    }

    .case-meta {
      display: flex;
      gap: var(--space-3);
      align-items: center;
    }

    .case-type {
      background: var(--gray-100);
      color: var(--gray-700);
      padding: var(--space-1) var(--space-3);
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
    }

    .case-priority {
      padding: var(--space-1) var(--space-3);
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-semibold);
    }

    .case-priority.high {
      background: var(--error-50);
      color: var(--error-600);
    }

    .case-id-display {
      text-align: right;
    }

    .case-id-label {
      display: block;
      font-size: var(--font-size-xs);
      color: var(--gray-500);
      margin-bottom: var(--space-1);
    }

    .case-id-display code {
      background: var(--gray-100);
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-sm);
      font-family: monospace;
      font-size: var(--font-size-sm);
      color: var(--gray-700);
    }

    /* Status Controls */
    .status-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: var(--space-4);
    }

    .status-buttons {
      display: flex;
      gap: var(--space-2);
      flex-wrap: wrap;
    }

    .status-btn {
      padding: var(--space-2) var(--space-4);
      border-radius: var(--radius-lg);
      font-weight: var(--font-weight-medium);
      cursor: pointer;
      transition: all var(--transition-fast);
      border: 2px solid var(--gray-300);
      font-size: var(--font-size-sm);
    }

    .status-btn:hover {
      background: var(--gray-100);
      border-color: var(--gray-400);
    }

    .status-btn.active {
      background-color: var(--primary-600);
      color: white;
      border-color: var(--primary-600);
    }

    .status-actions {
      display: flex;
      gap: var(--space-3);
    }

    /* Communication Section */
    .communication-section {
      background: white;
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-lg);
      overflow: hidden;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .chat-container {
      display: flex;
      flex-direction: column;
      height: 600px;
    }

    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-4) var(--space-6);
      border-bottom: 1px solid var(--gray-200);
      background: var(--gray-50);
    }

    .chat-header h3 {
      margin: 0;
      font-size: var(--font-size-lg);
      color: var(--gray-800);
    }

    .chat-actions {
      display: flex;
      gap: var(--space-2);
    }

    .btn-sm {
      padding: var(--space-2) var(--space-3);
      font-size: var(--font-size-xs);
      border-radius: var(--radius-md);
    }

    /* Chat Messages */
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-4) var(--space-6);
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
    }

    .message {
      max-width: 80%;
      padding: var(--space-4);
      border-radius: var(--radius-lg);
      position: relative;
    }

    .message.admin {
      align-self: flex-end;
      background: var(--primary-50);
      border: 1px solid var(--primary-200);
    }

    .message.customer {
      align-self: flex-start;
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
    }

    .message.system {
      align-self: center;
      background: var(--warning-50);
      border: 1px solid var(--warning-200);
      max-width: 90%;
    }

    .message-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-2);
      font-size: var(--font-size-sm);
    }

    .message-header strong {
      color: var(--gray-800);
    }

    .message-time {
      color: var(--gray-500);
      font-size: var(--font-size-xs);
      font-weight: normal;
    }

    .message-content {
      color: var(--gray-700);
      line-height: 1.5;
    }

    /* Response Templates */
    .response-templates {
      padding: var(--space-4) var(--space-6);
      border-top: 1px solid var(--gray-200);
      background: var(--gray-50);
    }

    .response-templates h4 {
      margin: 0 0 var(--space-3);
      font-size: var(--font-size-sm);
      color: var(--gray-700);
    }

    .template-buttons {
      display: flex;
      gap: var(--space-2);
      flex-wrap: wrap;
    }

    .template-btn {
      background: white;
      border: 1px solid var(--gray-300);
      padding: var(--space-2) var(--space-3);
      border-radius: var(--radius-md);
      font-size: var(--font-size-xs);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .template-btn:hover {
      background: var(--primary-50);
      border-color: var(--primary-300);
    }

    /* Message Input */
    .message-input {
      padding: var(--space-4) var(--space-6);
      border-top: 1px solid var(--gray-200);
      background: white;
    }

    .message-input textarea {
      width: 100%;
      border: 1px solid var(--gray-300);
      border-radius: var(--radius-lg);
      padding: var(--space-3);
      resize: vertical;
      min-height: 60px;
      font-family: inherit;
      margin-bottom: var(--space-3);
    }

    .message-input textarea:focus {
      outline: none;
      border-color: var(--primary-500);
      box-shadow: 0 0 0 3px var(--primary-50);
    }

    .input-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .input-actions .btn-sm {
      background: var(--gray-100);
      border: 1px solid var(--gray-300);
      color: var(--gray-600);
    }

    .input-actions .btn-sm:hover {
      background: var(--gray-200);
    }

    /* Case Details Section */
    .case-details-section {
      background: white;
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-lg);
      overflow: hidden;
    }

    .toggle-details-btn {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-4) var(--space-6);
      background: var(--gray-50);
      border: none;
      cursor: pointer;
      font-size: var(--font-size-base);
      color: var(--gray-700);
      transition: all var(--transition-fast);
    }

    .toggle-details-btn:hover {
      background: var(--gray-100);
    }

    .toggle-icon {
      transition: transform var(--transition-fast);
    }

    .toggle-details-btn.expanded .toggle-icon {
      transform: rotate(180deg);
    }

    .case-details-content {
      padding: var(--space-6);
    }

    /* Existing Styles */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .case-details {
      display: grid;
      gap: var(--space-3);
      margin-bottom: var(--space-6);
    }

    .detail-item {
      display: flex;
      align-items: flex-start;
      gap: var(--space-4);
    }

    .detail-item dt {
      font-weight: var(--font-weight-semibold);
      color: var(--gray-700);
      min-width: 120px;
    }

    .detail-item dd {
      margin: 0;
      flex: 1;
      color: var(--gray-600);
    }

    .admin-assignment {
      margin-bottom: var(--space-6);
    }

    .readonly-box {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      background: var(--gray-100);
      padding: var(--space-3);
      border-radius: var(--radius-lg);
      margin-top: var(--space-2);
    }

    .readonly-box input {
      margin: 0;
      background: transparent;
      border: none;
    }

    .edit-icon {
      cursor: pointer;
      font-size: var(--font-size-lg);
      color: var(--gray-600);
      transition: color var(--transition-fast);
    }

    .edit-icon:hover {
      color: var(--primary-600);
    }

    .note-section {
      margin-top: var(--space-6);
      padding-top: var(--space-6);
      border-top: 1px solid var(--gray-200);
    }

    .note-list {
      margin-top: var(--space-4);
    }

    .note-item {
      background: var(--gray-50);
      padding: var(--space-4);
      border-radius: var(--radius-lg);
      margin-top: var(--space-3);
      border-left: 4px solid var(--primary-500);
    }

    .note-item small {
      display: block;
      color: var(--gray-500);
      margin-top: var(--space-2);
      font-size: var(--font-size-sm);
    }

    /* Mobile Responsiveness */
    @media (max-width: 1024px) {
      .case-detail-container {
        grid-template-columns: 280px 1fr;
        gap: var(--space-4);
        padding: var(--space-4);
      }
    }

    @media (max-width: 768px) {
      .case-detail-container {
        grid-template-columns: 1fr;
        gap: var(--space-4);
      }

      .case-sidebar {
        position: static;
        order: 2;
      }

      .case-main {
        order: 1;
      }

      .status-controls {
        flex-direction: column;
        align-items: stretch;
        gap: var(--space-4);
      }

      .status-buttons {
        justify-content: center;
      }

      .status-actions {
        justify-content: center;
      }

      .case-header {
        flex-direction: column;
        align-items: stretch;
        gap: var(--space-4);
      }

      .case-id-display {
        text-align: left;
      }

      .chat-container {
        height: 500px;
      }

      .message {
        max-width: 95%;
      }

      .template-buttons {
        flex-direction: column;
      }

      .input-actions {
        flex-direction: column;
        gap: var(--space-2);
      }

      .input-actions .btn-sm {
        align-self: flex-start;
      }
    }

    /* Notification animations */
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }
  </style>

<script>
  const sessionId = new URLSearchParams(window.location.search).get("sessionId");
  let currentAdmins = [];
  let editingAdmin = false;

  // Quick Response Templates
  const responseTemplates = {
    greeting: "Hej! Tack för att du kontaktar oss. Jag hjälper dig gärna med detta.",
    "info-request": "För att hjälpa dig bättre, behöver jag lite mer information om problemet. Kan du beskriva vad som hänt?",
    resolution: "Problemet är nu löst. Finns det något annat jag kan hjälpa dig med?",
    "follow-up": "Jag följer upp detta och återkommer till dig inom kort."
  };

  async function loadCaseData() {
    const res = await fetch(`/api/cases/meta/${sessionId}`);
    const data = await res.json();

    // Update case information
    document.getElementById("case-id").textContent = data._id;
    document.getElementById("case-id-code").textContent = data._id;
    document.getElementById("customer-name").textContent = data.customerName || "Okänd";
    document.getElementById("customer-email").textContent = data.customerEmail || "Ingen e-post";
    document.getElementById("customer-id").textContent = `ID: ${data._id}`;
    document.getElementById("case-type").textContent = data.topic || "-";
    document.getElementById("case-type-display").textContent = `📝 ${data.topic || "Okänd"}`;
    document.getElementById("case-title").textContent = data.topic || "Okänt ärende";
    document.getElementById("case-description").textContent = data.description || "-";
    document.getElementById("created-at").textContent = new Date(data.createdAt).toLocaleString("sv-SE");
    document.getElementById("case-created-time").textContent = new Date(data.createdAt).toLocaleString("sv-SE");
    document.getElementById("admin-display").value = data.assignedAdminName || "Ingen";

    // Update customer avatar with initials
    const customerName = data.customerName || "Okänd";
    const initials = customerName.split(' ').map(n => n[0]).join('').toUpperCase();
    document.getElementById("customer-avatar").textContent = initials;

    // Build comprehensive timeline
    buildTimeline(data);

    // Update SLA timer
    updateSLATimer(data);

    // Update status button
    const btn = document.querySelector(`.status-buttons button[data-status="${data.status}"]`);
    if (btn) btn.classList.add("active");

    // Update chat messages
    const transcript = document.getElementById("chat-transcript");
    if (data.messages && data.messages.length > 0) {
      transcript.innerHTML = data.messages.map(msg => {
        const messageClass = msg.sender === 'customer' ? 'customer' : 
                            msg.sender === 'system' ? 'system' : 'admin';
        const senderDisplay = msg.senderName || msg.sender;
        const senderEmail = msg.senderEmail ? ` (${msg.senderEmail})` : '';
        
        return `
          <div class="message ${messageClass}">
            <div class="message-header">
              <strong>${senderDisplay}${senderEmail}</strong>
              <span class="message-time">${new Date(msg.timestamp).toLocaleString("sv-SE")}</span>
            </div>
            <div class="message-content">${msg.message}</div>
          </div>
        `;
      }).join("");
      
      // Scroll to bottom of messages
      transcript.scrollTop = transcript.scrollHeight;
    } else {
      transcript.innerHTML = '<div class="message system"><div class="message-content">Inga meddelanden än. Konversationen kommer att visas här.</div></div>';
    }

    // Update internal notes
    const noteList = document.getElementById("note-list");
    if (data.internalNotes && data.internalNotes.length > 0) {
      noteList.innerHTML = data.internalNotes.map(n => `
        <div class="note-item">
          ${n.note}
          <small>🕒 ${new Date(n.timestamp || Date.now()).toLocaleString("sv-SE")}</small>
        </div>
      `).join("");
    } else {
      noteList.innerHTML = '<p class="text-gray-500">Inga interna anteckningar än.</p>';
    }
  }

  async function loadAdmins() {
    const res = await fetch("/api/admins");
    currentAdmins = await res.json();
  }

  function toggleEditAdmin() {
    if (!editingAdmin) {
      document.getElementById("admin-display").style.display = "none";
      document.getElementById("admin-input").style.display = "block";
      editingAdmin = true;
    } else {
      const name = document.getElementById("admin-input").value;
      const match = currentAdmins.find(a => a.name.toLowerCase() === name.toLowerCase());
      if (match) {
        fetch("/api/cases/assign-admin", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ sessionId, adminId: match._id })
        }).then(() => {
          document.getElementById("admin-display").value = match.name;
          document.getElementById("admin-display").style.display = "block";
          document.getElementById("admin-input").style.display = "none";
          editingAdmin = false;
        });
      }
    }
  }

  function filterAdmins(value) {
    const datalist = document.getElementById("admin-suggestions");
    datalist.innerHTML = "";
    currentAdmins
      .filter(a => a.name.toLowerCase().includes(value.toLowerCase()))
      .forEach(a => {
        const option = document.createElement("option");
        option.value = a.name;
        datalist.appendChild(option);
      });
  }

  function saveNote() {
    const note = document.getElementById("internal-note").value;
    if (!note.trim()) return alert("Ange en anteckning.");
    fetch("/api/cases/add-note", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ sessionId, note })
    })
      .then(res => res.json())
      .then(result => {
        if (result.success) {
          alert("📝 Anteckning sparad.");
          document.getElementById("internal-note").value = "";
          loadCaseData(); // 🔄 Ladda om anteckningar direkt
        } else {
          alert("❌ Kunde inte spara anteckning.");
        }
      });
  }

  function sendMessage() {
    const msg = document.getElementById("customer-message").value;
    if (!msg.trim()) return alert("Ange ett meddelande.");
    fetch("/api/cases/send-message", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ sessionId, message: msg })
    }).then(() => {
      alert("📨 Meddelande skickat.");
      document.getElementById("customer-message").value = "";
      loadCaseData();
    });
  }

  // SLA Timer functionality
  function updateSLATimer(data) {
    const responseTimeLimit = 2 * 60 * 60 * 1000; // 2 hours in milliseconds
    const resolutionTimeLimit = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
    
    const caseCreated = new Date(data.createdAt);
    const now = new Date();
    const timeSinceCreation = now - caseCreated;
    
    // Check if there are any admin responses
    const hasAdminResponse = data.messages && data.messages.some(msg => msg.sender === 'admin');
    
    let remainingTime, status, statusClass;
    
    if (hasAdminResponse) {
      // Case has been responded to, show resolution SLA
      const remainingResolution = resolutionTimeLimit - timeSinceCreation;
      remainingTime = remainingResolution > 0 ? formatTime(remainingResolution) : 'Över tid';
      status = remainingResolution > 0 ? 'På rätt väg' : 'Över tid';
      statusClass = remainingResolution > 0 ? 'on-track' : 'overdue';
    } else {
      // No admin response yet, show response SLA
      const remainingResponse = responseTimeLimit - timeSinceCreation;
      remainingTime = remainingResponse > 0 ? formatTime(remainingResponse) : 'Över tid';
      
      if (remainingResponse > responseTimeLimit * 0.5) {
        status = 'På rätt väg';
        statusClass = 'on-track';
      } else if (remainingResponse > 0) {
        status = 'Varning';
        statusClass = 'warning';
      } else {
        status = 'Över tid';
        statusClass = 'overdue';
      }
    }
    
    // Update DOM
    document.getElementById('response-time').textContent = hasAdminResponse ? '24 timmar' : '2 timmar';
    document.getElementById('response-remaining').textContent = remainingTime;
    
    const statusElement = document.getElementById('sla-status');
    statusElement.textContent = status;
    statusElement.className = `sla-status ${statusClass}`;
  }

  function formatTime(milliseconds) {
    const hours = Math.floor(milliseconds / (1000 * 60 * 60));
    const minutes = Math.floor((milliseconds % (1000 * 60 * 60)) / (1000 * 60));
    
    if (hours > 0) {
      return `${hours}h ${minutes}m`;
    } else {
      return `${minutes}m`;
    }
  }

  // Timeline functionality
  function buildTimeline(data) {
    const timelineContainer = document.getElementById("timeline-container");
    const timelineEvents = [];

    // Case creation
    timelineEvents.push({
      type: 'created',
      title: 'Ärende skapat',
      time: data.createdAt,
      description: `Skapat av kund: ${data.customerName || 'Okänd'}`
    });

    // Messages
    if (data.messages && data.messages.length > 0) {
      data.messages.forEach(msg => {
        const sender = msg.senderName || msg.sender;
        timelineEvents.push({
          type: 'message',
          title: `${sender} skickade meddelande`,
          time: msg.timestamp,
          description: msg.message.substring(0, 50) + (msg.message.length > 50 ? '...' : '')
        });
      });
    }

    // Internal notes
    if (data.internalNotes && data.internalNotes.length > 0) {
      data.internalNotes.forEach(note => {
        timelineEvents.push({
          type: 'status',
          title: 'Intern anteckning tillagd',
          time: note.timestamp || note.createdAt,
          description: note.note.substring(0, 50) + (note.note.length > 50 ? '...' : '')
        });
      });
    }

    // Sort by timestamp
    timelineEvents.sort((a, b) => new Date(a.time) - new Date(b.time));

    // Build timeline HTML
    timelineContainer.innerHTML = timelineEvents.map(event => `
      <div class="timeline-item">
        <span class="timeline-dot ${event.type}"></span>
        <div class="timeline-content">
          <strong>${event.title}</strong>
          <span>${new Date(event.time).toLocaleString("sv-SE")}</span>
          ${event.description ? `<div class="timeline-description">${event.description}</div>` : ''}
        </div>
      </div>
    `).join('');
  }

  // New enhanced functionality
  function toggleCaseDetails() {
    const content = document.getElementById("case-details-content");
    const btn = document.querySelector(".toggle-details-btn");
    const icon = btn.querySelector(".toggle-icon");
    
    if (content.style.display === "none") {
      content.style.display = "block";
      btn.classList.add("expanded");
    } else {
      content.style.display = "none";
      btn.classList.remove("expanded");
    }
  }

  function useTemplate(templateKey) {
    const template = responseTemplates[templateKey];
    if (template) {
      document.getElementById("customer-message").value = template;
      document.getElementById("customer-message").focus();
    }
  }

  function searchMessages() {
    const query = prompt("Sök i meddelanden:");
    if (query) {
      const messages = document.querySelectorAll('.message');
      messages.forEach(msg => {
        const content = msg.textContent.toLowerCase();
        if (content.includes(query.toLowerCase())) {
          msg.style.backgroundColor = '#fff3cd';
          msg.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
          msg.style.backgroundColor = '';
        }
      });
    }
  }

  function filterMessages() {
    const filter = prompt("Filtrera meddelanden (admin/customer/system):");
    if (filter) {
      const messages = document.querySelectorAll('.message');
      messages.forEach(msg => {
        if (msg.classList.contains(filter.toLowerCase())) {
          msg.style.display = 'block';
        } else {
          msg.style.display = 'none';
        }
      });
    }
  }

  function resetMessageFilter() {
    const messages = document.querySelectorAll('.message');
    messages.forEach(msg => {
      msg.style.display = 'block';
      msg.style.backgroundColor = '';
    });
  }

  function attachFile() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.pdf,.doc,.docx,.jpg,.jpeg,.png,.gif,.txt';
    input.onchange = function(e) {
      const file = e.target.files[0];
      if (file) {
        alert(`Fil vald: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`);
        // Here you would typically upload the file and add it to the message
      }
    };
    input.click();
  }

  // Event listeners for enhanced functionality
  document.querySelectorAll(".status-buttons button").forEach(button => {
    button.addEventListener("click", () => {
      document.querySelectorAll(".status-buttons button").forEach(b => b.classList.remove("active"));
      button.classList.add("active");
    });
  });

  document.getElementById("update-status-btn").addEventListener("click", () => {
    const activeBtn = document.querySelector(".status-buttons button.active");
    if (!activeBtn) return alert("Välj en status först.");
    fetch("/api/cases/update-status", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ sessionId, status: activeBtn.dataset.status })
    }).then(() => alert("✅ Status uppdaterad!"));
  });

  // Quick response template buttons
  document.querySelectorAll(".template-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const templateKey = btn.dataset.template;
      useTemplate(templateKey);
    });
  });

  // Chat action buttons
  document.getElementById("search-messages-btn").addEventListener("click", searchMessages);
  document.getElementById("filter-messages-btn").addEventListener("click", filterMessages);
  document.getElementById("attach-file-btn").addEventListener("click", attachFile);

  // Send message button
  document.getElementById("send-message-btn").addEventListener("click", sendMessage);

  // Quick action buttons
  document.getElementById("call-customer-btn").addEventListener("click", () => {
    alert("Ring kund-funktionen kommer att implementeras");
  });

  document.getElementById("email-customer-btn").addEventListener("click", () => {
    const email = document.getElementById("customer-email").textContent;
    if (email && email !== "Ingen e-post") {
      window.open(`mailto:${email}`, '_blank');
    } else {
      alert("Ingen e-postadress tillgänglig för denna kund");
    }
  });

  document.getElementById("view-profile-btn").addEventListener("click", () => {
    alert("Visa profil-funktionen kommer att implementeras");
  });

  // Add note button
  document.getElementById("add-note-btn").addEventListener("click", () => {
    const note = prompt("Skriv din interna anteckning:");
    if (note && note.trim()) {
      fetch("/api/cases/add-note", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ sessionId, note: note.trim() })
      })
        .then(res => res.json())
        .then(result => {
          if (result.success) {
            alert("📝 Anteckning sparad.");
            loadCaseData();
          } else {
            alert("❌ Kunde inte spara anteckning.");
          }
        });
    }
  });

  // Enter key to send message
  document.getElementById("customer-message").addEventListener("keydown", (e) => {
    if (e.key === "Enter" && e.ctrlKey) {
      sendMessage();
    }
  });

  // Real-time updates
  let socket = null;
  let lastMessageCount = 0;

  function initializeRealTimeUpdates() {
    // Check if socket.io is available
    if (typeof io !== 'undefined') {
      socket = io();
      
      socket.on('newMessage', (data) => {
        if (data.sessionId === sessionId) {
          showNotification('Nytt meddelande mottaget');
          loadCaseData();
        }
      });

      socket.on('caseStatusUpdate', (data) => {
        if (data.sessionId === sessionId) {
          showNotification('Ärendestatus uppdaterad');
          loadCaseData();
        }
      });

      socket.on('caseNoteAdded', (data) => {
        if (data.sessionId === sessionId) {
          showNotification('Intern anteckning tillagd');
          loadCaseData();
        }
      });
    } else {
      // Fallback to polling if WebSocket not available
      setInterval(checkForUpdates, 30000); // Check every 30 seconds
    }
  }

  function checkForUpdates() {
    fetch(`/api/cases/meta/${sessionId}`)
      .then(res => res.json())
      .then(data => {
        const currentMessageCount = data.messages ? data.messages.length : 0;
        if (currentMessageCount > lastMessageCount) {
          showNotification('Nya meddelanden tillgängliga');
          loadCaseData();
        }
        lastMessageCount = currentMessageCount;
      })
      .catch(err => console.error('Error checking for updates:', err));
  }

  function showNotification(message) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = 'notification';
    notification.textContent = message;
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--primary-600);
      color: white;
      padding: var(--space-3) var(--space-4);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
    `;
    
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
      notification.style.animation = 'slideOut 0.3s ease-out';
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 300);
    }, 3000);
  }

  // Initialize
  loadCaseData();
  loadAdmins();
  initializeRealTimeUpdates();
</script>
</body>
</html>
