<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin – Marknadsföring</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/theme.css">
  <style>
    /* Marketing-specific styles */
    .category-tabs {
      display: flex;
      gap: var(--space-2);
      margin-bottom: var(--space-6);
      border-bottom: 1px solid var(--gray-200);
    }
    
    .tab-btn {
      padding: var(--space-3) var(--space-6);
      border: none;
      background: transparent;
      color: var(--gray-600);
      font-weight: 500;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all var(--transition-normal);
    }
    
    .tab-btn:hover {
      color: var(--primary-color);
    }
    
    .tab-btn.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
    }
    
    .toolbar {
      display: flex;
      gap: var(--space-4);
      margin-bottom: var(--space-6);
      flex-wrap: wrap;
      align-items: center;
    }
    
    .toolbar .form-control {
      min-width: 200px;
    }
    
    .brief-item {
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
      padding: var(--space-5);
      margin-bottom: var(--space-4);
      transition: all var(--transition-normal);
    }
    
    .brief-item:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }
    
    .brief-header {
      display: flex;
      justify-content: between;
      align-items: flex-start;
      margin-bottom: var(--space-3);
    }
    
    .brief-title {
      font-size: var(--font-size-lg);
      font-weight: 600;
      color: var(--gray-900);
      margin: 0;
    }
    
    .brief-meta {
      color: var(--gray-600);
      font-size: var(--font-size-sm);
      margin-top: var(--space-2);
    }
    
    .badge {
      display: inline-block;
      padding: var(--space-1) var(--space-3);
      border-radius: var(--radius-md);
      font-size: var(--font-size-xs);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .badge.blue {
      background: var(--primary-light);
      color: var(--primary-color);
    }
    
    .badge.orange {
      background: #fed7aa;
      color: #ea580c;
    }
    
    .badge.green {
      background: #dcfce7;
      color: #16a34a;
    }
    
    .summary-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-4);
      margin-top: var(--space-6);
      padding: var(--space-6);
      background: var(--white);
      border-radius: var(--radius-xl);
      border: 1px solid var(--gray-200);
    }
    
    .stat-item {
      text-align: center;
    }
    
    .stat-number {
      font-size: var(--font-size-3xl);
      font-weight: 700;
      color: var(--primary-color);
      display: block;
    }
    
    .stat-label {
      font-size: var(--font-size-sm);
      color: var(--gray-600);
      margin-top: var(--space-1);
    }
    
    .pager {
      display: flex;
      justify-content: center;
      gap: var(--space-2);
      margin-top: var(--space-6);
    }
    
    .pager .btn {
      padding: var(--space-2) var(--space-4);
    }
    
    .back-button {
      margin-bottom: var(--space-6);
    }
    
    .back-button a {
      color: var(--gray-600);
      text-decoration: none;
      font-weight: 500;
    }
    
    .back-button a:hover {
      color: var(--primary-color);
    }
  </style>
</head>
<body>
<div class="container">
        <aside class="sidebar" role="navigation" aria-label="Huvudnavigation">
    <div class="logo">
      <img src="/images/Source.png" alt="Source Logo" width="160" height="auto" />
    </div>
    <nav class="menu" aria-label="Admin Portal Navigation">
      <a href="/dashboard" class="menu-item">
        Hem och data
      </a>
      <a href="/search.html" class="menu-item">
        Sök Kund
      </a>
      <a href="/cases.html" class="menu-item">
        Cases & kundkontakt
      </a>
      <a href="/avtal.html" class="menu-item">
        Avtal
      </a>
      <a href="/invoicing.html" class="menu-item">
        Faktuering
      </a>
      <a href="/admin-marknadsforing.html" class="menu-item active" aria-current="page">
        Marknadsföring
      </a>
      <a href="/massmail.html" class="menu-item">
        Massutskick av Mejl
      </a>
      <a href="/onboarding.html" class="menu-item">
        Onboarding
      </a>
    </nav>
  </aside>

  <main class="main-content">
    <div class="back-button">
      <a href="admin-dashboard.html">
        ← Tillbaka till Dashboard
      </a>
    </div>
    <h1>Marknadsföring & Analytics</h1>

    <!-- Marketing Briefs Section -->
    <section class="card">
      <h2>Marketing Briefs</h2>
      <div class="category-tabs">
        <button class="tab-btn active" data-category="ads">Ads</button>
        <button class="tab-btn" data-category="ai-studio">AI Studio</button>
        <button class="tab-btn" data-category="radgivning">Rådgivning</button>
      </div>
      
      <div class="sort-controls">
        <label for="adsSort">Sortera briefs:</label>
        <select id="adsSort">
          <option value="createdAt-desc">Senast skapade (nyast först)</option>
          <option value="createdAt-asc">Äldst skapade (äldst först)</option>
          <option value="category-asc">Kategori (A-Ö)</option>
          <option value="category-desc">Kategori (Ö-A)</option>
          <option value="tenantId-asc">Företag (A-Ö)</option>
          <option value="tenantId-desc">Företag (Ö-A)</option>
        </select>
      </div>
      
      <div class="toolbar">
        <input id="q" type="search" placeholder="Sök i svaren…"/>
        <input id="from" type="date"/>
        <input id="to" type="date"/>
        <select id="category">
          <option value="">Alla kategorier</option>
          <option value="ads">Ads</option>
          <option value="ai-studio">AI Studio</option>
          <option value="radgivning">Rådgivning</option>
        </select>
        <button id="filterBtn" class="btn">Filtrera</button>
        <span id="adsStatus" class="status">–</span>
      </div>

      <div id="adsList" class="grid">
        <p class="meta">Laddar briefs…</p>
      </div>

      <div class="pager">
        <button id="prevAds" class="btn">Föregående</button>
        <span id="adsPageLbl" class="status"></span>
        <button id="nextAds" class="btn">Nästa</button>
      </div>
    </section>

    <!-- Summary Section -->
      <section class="card">
      <h2>Sammanfattning</h2>
        <div id="summaryBox" class="kv">
          <div>Antal briefs</div><div id="sumBriefs">–</div>
        <div>Ads</div><div id="sumAds">–</div>
        <div>AI Studio</div><div id="sumAIStudio">–</div>
        <div>Rådgivning</div><div id="sumRadgivning">–</div>
          <div>Källa</div><div id="sumSource">–</div>
        </div>
      </section>
  </main>
</div>

<script>
  // === Utils ===
  function esc(s){ return String(s != null ? s : '').replace(/[&<>"]/g, m => ( {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'} )[m]); }
  function dse(x){ try{ return new Date(x).toLocaleString('sv-SE'); } catch{ return '–'; } }
  function short(s, n=160){ s=String(s||''); return s.length>n? s.slice(0,n)+'…' : s; }
  function isObj(x){ return x && typeof x === 'object' && !Array.isArray(x); }

  // === State ===
  let page=1, limit=20, lastTotal=0, lastSource='primary';
  let adsSortBy = 'createdAt-desc';
  let currentCategory = 'ads';

  // Plocka ut answers oavsett schema (nytt eller legacy)
  function extractAnswers(it){
    if (isObj(it.answers)) return it.answers;
    const legacy = {};
    ['q1','q2','q3','q4','q5','q6','q7','extraInfo'].forEach(k => {
      if (it[k] != null && it[k] !== '') legacy[k] = it[k];
    });
    return legacy;
  }

  // Förhandsvisning av answers
  function answersPreview(ans){
    const vals = [];
    for (const [k,v] of Object.entries(ans)){
      if (v == null) continue;
      const val = typeof v === 'string' ? v : JSON.stringify(v);
      if (val.trim()) vals.push(val.trim());
      if (vals.length >= 6) break; // lagom preview
    }
    return short(vals.join(' | '));
  }

  // Renderar alla fält nyckel → värde (stabil ordning: q1..q7 först, därefter övriga)
  function renderAnswersTable(ans){
    const keys = Object.keys(ans);
    const preferred = ['q1','q2','q3','q4','q5','q6','q7','extraInfo'];
    const first = preferred.filter(k => keys.includes(k));
    const rest  = keys.filter(k => !preferred.includes(k)).sort();
    const order = [...first, ...rest];

    return `
      <div class="kv">
        ${order.map(k => {
          const v = ans[k];
          const val = typeof v === 'string' ? v : JSON.stringify(v, null, 0);
          return `<div>${esc(k.toUpperCase())}</div><div>${esc(val)}</div>`;
        }).join('')}
      </div>
    `;
  }

  function iconFor(p){
    const map = { google:'fa-google', meta:'fa-facebook', tiktok:'fa-tiktok', linkedin:'fa-linkedin' };
    const i = map[p] || 'fa-bullhorn';
    return `<i class="fa-brands ${i}"></i>`;
  }

  // === Category tab switching ===
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentCategory = btn.dataset.category;
      document.getElementById('category').value = currentCategory;
      page = 1;
      loadAds();
    });
  });

  // === ADS (briefs) ===
  async function loadAds(){
    const elList = document.getElementById('adsList');
    const elLbl  = document.getElementById('adsPageLbl');
    const elSt   = document.getElementById('adsStatus');

    const q = document.getElementById('q').value.trim();
    const from = document.getElementById('from').value;
    const to   = document.getElementById('to').value;
    const category = document.getElementById('category').value;

    const params = new URLSearchParams({ page, limit });
    if (q) params.set('q', q);
    if (category) params.set('category', category);
    if (from) params.set('from', new Date(from).toISOString());
    if (to)   params.set('to', new Date(to).toISOString());
    if (adsSortBy) params.set('sort', adsSortBy);

    elList.innerHTML = '<p class="meta">Hämtar…</p>';

    try{
      const res = await fetch('/api/admin/ads?'+params.toString(), { credentials: 'include' });
      if (!res.ok) throw new Error('GET /admin/api/ads: '+res.status);
      const data = await res.json();

      lastTotal = data.total || 0;
      lastSource = data.source || 'primary';
      elLbl.textContent = `Sida ${data.page || page} • ${data.total || 0} poster`;
      elSt.textContent  = `Källa: ${lastSource}`;

      if (!data.items?.length){
        elList.innerHTML = `<p class="empty">Inga briefs hittades för kategori "${currentCategory}".</p>`;
        updateSummary();
        return;
      }

      updateSummary();
      elList.innerHTML = data.items.map(renderAdItem).join('');
      bindAdDetailButtons();
    }catch(err){
      console.error(err);
      elList.innerHTML = `<p class="error">Kunde inte hämta briefs. Är <code>/admin/api/ads</code> implementerad?</p>`;
      elLbl.textContent = '';
      elSt.textContent  = 'Fel';
    }
  }

  function renderAdItem(it){
    const ans = extractAnswers(it);
    const preview = esc(answersPreview(ans));
    const platform = String(it.platform || '-').toLowerCase();
    const category = it.category || 'ads';
    
    // Category-specific rendering
    let categoryBadge = '';
    let categoryContent = '';
    
    switch (category) {
      case 'ai-studio':
        categoryBadge = '<span class="badge orange">AI Studio</span>';
        if (it.aiStudioData) {
          categoryContent = `
            <div class="meta" style="margin-top:.25rem">
              <strong>Typ:</strong> ${esc(it.aiStudioData.generationType || 'Okänt')}
            </div>
            ${it.aiStudioData.generatedImages?.length ? `
              <div class="meta" style="margin-top:.25rem">
                <strong>Genererade bilder:</strong> ${it.aiStudioData.generatedImages.length} st
                <div style="margin-top:.25rem;display:flex;gap:.25rem;flex-wrap:wrap">
                  ${it.aiStudioData.generatedImages.map(img => 
                    `<img src="${esc(img)}" 
                         style="width:60px;height:60px;object-fit:cover;border-radius:4px;border:2px solid #e9ecef;cursor:pointer" 
                         alt="Generated image" 
                         onclick="window.open('${esc(img)}', '_blank')" 
                         title="Klicka för att öppna i ny flik" />`
                  ).join('')}
                </div>
              </div>
            ` : ''}
            ${it.aiStudioData.generatedPDFs?.length ? `
              <div class="meta" style="margin-top:.25rem">
                <strong>Genererade PDFs:</strong> 
                <div style="margin-top:.25rem;display:flex;gap:.25rem;flex-wrap:wrap">
                  ${it.aiStudioData.generatedPDFs.map(pdf => 
                    `<a href="${esc(pdf)}" target="_blank" 
                       style="display:inline-block;padding:.25rem .5rem;background:#dc3545;color:white;text-decoration:none;border-radius:4px;font-size:.8rem;font-weight:500">
                       📄 PDF
                     </a>`
                  ).join('')}
                </div>
              </div>
            ` : ''}
            ${it.aiStudioData.prompt ? `
              <details style="margin-top:.5rem">
                <summary style="cursor:pointer;font-weight:500;color:#fd7e14">Visa prompt</summary>
                <div style="margin-top:.25rem;padding:.5rem;background:#fff3cd;border-radius:4px;border-left:3px solid #ffc107">
                  <em style="color:#856404">${esc(it.aiStudioData.prompt)}</em>
                </div>
              </details>
            ` : ''}
          `;
        }
        break;
      case 'radgivning':
        categoryBadge = '<span class="badge blue">Rådgivning</span>';
        if (it.radgivningData && it.radgivningData.questions) {
          categoryContent = `
            <div class="meta" style="margin-top:.25rem">
              <strong>Frågor besvarade:</strong> ${it.radgivningData.questions.length}
            </div>
            <div class="meta" style="margin-top:.25rem">
              <strong>Prioritet:</strong> ${esc(it.radgivningData.priority || 'medium')}
            </div>
            <details style="margin-top:.5rem">
              <summary style="cursor:pointer;font-weight:500;color:#007bff">Visa alla svar</summary>
              <div style="margin-top:.5rem;padding:.5rem;background:#f8f9fa;border-radius:4px;border-left:3px solid #007bff">
                ${it.radgivningData.questions.map(q => 
                  `<div style="margin-bottom:.75rem;padding-bottom:.5rem;border-bottom:1px solid #e9ecef">
                    <strong style="color:#495057">${esc(q.question)}:</strong><br/>
                    <span style="color:#6c757d;margin-top:.25rem;display:inline-block">${esc(q.answer)}</span>
                  </div>`
                ).join('')}
              </div>
            </details>
          `;
        }
        break;
      default:
        categoryBadge = '<span class="badge green">Ads</span>';
        break;
    }

    const idBtn = it._id
      ? `<button class="btn btn-detail" data-id="${esc(it._id)}">Visa detalj</button>`
      : `<span class="badge gray">Ingen detalj (legacy)</span>`;

    const tenantName = it.tenantId || it.tenant || 'Okänt företag';
    const objectId = it.userId || it.objectId || it.meta?.userId || it._id || 'Ingen Object ID';
    const userLabel = `${esc(tenantName)} (${esc(objectId)})`;

    return `
      <div class="card">
        <div class="row">
          <div>
            <div class="badges">${categoryBadge} ${platform !== '-' ? `<span class="badge">${esc(platform)}</span>` : ''}</div>
            <h3 style="margin:.35rem 0 .15rem 0">${esc(userLabel)}</h3>
            <div class="meta">Skapad: ${dse(it.createdAt)}</div>
          </div>
          <div class="platforms" title="Plattform">${iconFor(platform)}</div>
        </div>

        <div class="meta" style="margin-top:.4rem">${preview || '<span class="meta">–</span>'}</div>
        ${it.userEmail ? `<div class="meta" style="margin-top:.25rem">E-post: ${esc(it.userEmail)}</div>` : ''}
        ${categoryContent}

        <details>
          <summary>Visa fälten</summary>
          ${renderAnswersTable(ans)}
        </details>

        <div style="margin-top:.5rem">${idBtn}</div>
      </div>
    `;
  }

  function bindAdDetailButtons(){
    document.querySelectorAll('.btn-detail').forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        const id = e.currentTarget.getAttribute('data-id');
        if (!id) return;
        try{
          const res = await fetch('/api/admin/ads/'+encodeURIComponent(id), { credentials:'include' });
          if (!res.ok) throw new Error('GET /admin/api/ads/:id '+res.status);
          const d = await res.json();
          alert(renderDoc(d)); // TODO: byt gärna till modal
        }catch(err){
          alert('Kunde inte hämta detalj: '+err.message);
        }
      });
    });
  }

  function renderDoc(d){
    const ans = extractAnswers(d);
    const hdr = [
      `category: ${d.category ?? '-'}`,
      `platform: ${d.platform ?? '-'}`,
      `tenantId: ${d.tenantId ?? '-'}`,
      `createdAt: ${dse(d.createdAt)}`
    ].join('\n');
    const kv = Object.entries(ans).map(([k,v]) => `${k}: ${typeof v==='string'? v : JSON.stringify(v)}`).join('\n');
    return `${hdr}\n---\n${kv}`;
  }

  // Enhanced summary update function that fetches true totals
  async function updateSummary() {
    try {
      const response = await fetch('/api/admin/ads/summary', { credentials: 'include' });
      if (!response.ok) throw new Error('Failed to fetch summary');
      
      const data = await response.json();
      
      document.getElementById('sumBriefs').textContent = data.total;
      document.getElementById('sumAds').textContent = data.ads;
      document.getElementById('sumAIStudio').textContent = data.aiStudio;
      document.getElementById('sumRadgivning').textContent = data.radgivning;
      document.getElementById('sumSource').textContent = 'Alla källor';
    } catch (error) {
      console.error('Failed to update summary:', error);
      // Fallback to showing current page data
      document.getElementById('sumBriefs').textContent = '–';
      document.getElementById('sumAds').textContent = '–';
      document.getElementById('sumAIStudio').textContent = '–';
      document.getElementById('sumRadgivning').textContent = '–';
      document.getElementById('sumSource').textContent = 'Fel vid hämtning';
    }
  }

  // Pager + filter + sort
  document.getElementById('filterBtn').addEventListener('click', ()=>{page=1; loadAds();});
  document.getElementById('prevAds').addEventListener('click', ()=>{ if (page>1){ page--; loadAds(); }});
  document.getElementById('nextAds').addEventListener('click', ()=>{ if (page*limit < lastTotal){ page++; loadAds(); }});
  document.getElementById('adsSort').addEventListener('change', (e)=>{adsSortBy=e.target.value; page=1; loadAds();});
  
  // Set initial sort values
  document.getElementById('adsSort').value = adsSortBy;
  
    // Check admin session before initializing
    fetch("/api/admin/me", { credentials: "include" })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          // Admin is logged in, initialize the page
          loadAds();
        } else {
          // Not logged in, redirect to login
          window.location.href = "/login.html";
        }
      })
      .catch(err => {
        console.error('Session check failed:', err);
        window.location.href = "/login.html";
      });
</script>

</body>
</html>