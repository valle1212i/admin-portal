<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin – Marknadsföring</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/admin-marknadsforing.css">
</head>
<body>
<div class="layout">
  <main>
    <div class="back-button">
      <a href="admin-dashboard.html">
        ← Tillbaka till Dashboard
      </a>
    </div>
    <h1>Marknadsföring & Analytics</h1>

    <!-- Marketing Briefs Section -->
    <section class="card">
      <h2>Marketing Briefs</h2>
      <div class="category-tabs">
        <button class="tab-btn active" data-category="ads">Ads</button>
        <button class="tab-btn" data-category="ai-studio">AI Studio</button>
        <button class="tab-btn" data-category="radgivning">Rådgivning</button>
      </div>
      
      <div class="sort-controls">
        <label for="adsSort">Sortera briefs:</label>
        <select id="adsSort">
          <option value="createdAt-desc">Senast skapade (nyast först)</option>
          <option value="createdAt-asc">Äldst skapade (äldst först)</option>
          <option value="category-asc">Kategori (A-Ö)</option>
          <option value="category-desc">Kategori (Ö-A)</option>
          <option value="tenantId-asc">Företag (A-Ö)</option>
          <option value="tenantId-desc">Företag (Ö-A)</option>
        </select>
      </div>
      
      <div class="toolbar">
        <input id="q" type="search" placeholder="Sök i svaren…"/>
        <input id="from" type="date"/>
        <input id="to" type="date"/>
        <select id="category">
          <option value="">Alla kategorier</option>
          <option value="ads">Ads</option>
          <option value="ai-studio">AI Studio</option>
          <option value="radgivning">Rådgivning</option>
        </select>
        <button id="filterBtn" class="btn">Filtrera</button>
        <span id="adsStatus" class="status">–</span>
      </div>

      <div id="adsList" class="grid">
        <p class="meta">Laddar briefs…</p>
      </div>

      <div class="pager">
        <button id="prevAds" class="btn">Föregående</button>
        <span id="adsPageLbl" class="status"></span>
        <button id="nextAds" class="btn">Nästa</button>
      </div>
    </section>

    <!-- Summary Section -->
    <section class="card">
      <h2>Sammanfattning</h2>
      <div id="summaryBox" class="kv">
        <div>Antal briefs</div><div id="sumBriefs">–</div>
        <div>Ads</div><div id="sumAds">–</div>
        <div>AI Studio</div><div id="sumAIStudio">–</div>
        <div>Rådgivning</div><div id="sumRadgivning">–</div>
        <div>Källa</div><div id="sumSource">–</div>
      </div>
    </section>
  </main>
</div>

<script>
  // === Utils ===
  function esc(s){ return String(s != null ? s : '').replace(/[&<>"]/g, m => ( {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'} )[m]); }
  function dse(x){ try{ return new Date(x).toLocaleString('sv-SE'); } catch{ return '–'; } }
  function short(s, n=160){ s=String(s||''); return s.length>n? s.slice(0,n)+'…' : s; }
  function isObj(x){ return x && typeof x === 'object' && !Array.isArray(x); }

  // === State ===
  let page=1, limit=20, lastTotal=0, lastSource='primary';
  let adsSortBy = 'createdAt-desc';
  let currentCategory = 'ads';

  // Plocka ut answers oavsett schema (nytt eller legacy)
  function extractAnswers(it){
    if (isObj(it.answers)) return it.answers;
    const legacy = {};
    ['q1','q2','q3','q4','q5','q6','q7','extraInfo'].forEach(k => {
      if (it[k] != null && it[k] !== '') legacy[k] = it[k];
    });
    return legacy;
  }

  // Förhandsvisning av answers
  function answersPreview(ans){
    const vals = [];
    for (const [k,v] of Object.entries(ans)){
      if (v == null) continue;
      const val = typeof v === 'string' ? v : JSON.stringify(v);
      if (val.trim()) vals.push(val.trim());
      if (vals.length >= 6) break; // lagom preview
    }
    return short(vals.join(' | '));
  }

  // Renderar alla fält nyckel → värde (stabil ordning: q1..q7 först, därefter övriga)
  function renderAnswersTable(ans){
    const keys = Object.keys(ans);
    const preferred = ['q1','q2','q3','q4','q5','q6','q7','extraInfo'];
    const first = preferred.filter(k => keys.includes(k));
    const rest  = keys.filter(k => !preferred.includes(k)).sort();
    const order = [...first, ...rest];

    return `
      <div class="kv">
        ${order.map(k => {
          const v = ans[k];
          const val = typeof v === 'string' ? v : JSON.stringify(v, null, 0);
          return `<div>${esc(k.toUpperCase())}</div><div>${esc(val)}</div>`;
        }).join('')}
      </div>
    `;
  }

  function iconFor(p){
    const map = { google:'fa-google', meta:'fa-facebook', tiktok:'fa-tiktok', linkedin:'fa-linkedin' };
    const i = map[p] || 'fa-bullhorn';
    return `<i class="fa-brands ${i}"></i>`;
  }

  // === Category tab switching ===
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentCategory = btn.dataset.category;
      document.getElementById('category').value = currentCategory;
      page = 1;
      loadAds();
    });
  });

  // === ADS (briefs) ===
  async function loadAds(){
    const elList = document.getElementById('adsList');
    const elLbl  = document.getElementById('adsPageLbl');
    const elSt   = document.getElementById('adsStatus');

    const q = document.getElementById('q').value.trim();
    const from = document.getElementById('from').value;
    const to   = document.getElementById('to').value;
    const category = document.getElementById('category').value;

    const params = new URLSearchParams({ page, limit });
    if (q) params.set('q', q);
    if (category) params.set('category', category);
    if (from) params.set('from', new Date(from).toISOString());
    if (to)   params.set('to', new Date(to).toISOString());
    if (adsSortBy) params.set('sort', adsSortBy);

    elList.innerHTML = '<p class="meta">Hämtar…</p>';

    try{
      const res = await fetch('/api/admin/ads?'+params.toString(), { credentials: 'include' });
      if (!res.ok) throw new Error('GET /admin/api/ads: '+res.status);
      const data = await res.json();

      lastTotal = data.total || 0;
      lastSource = data.source || 'primary';
      elLbl.textContent = `Sida ${data.page || page} • ${data.total || 0} poster`;
      elSt.textContent  = `Källa: ${lastSource}`;

      if (!data.items?.length){
        elList.innerHTML = `<p class="empty">Inga briefs hittades för kategori "${currentCategory}".</p>`;
        updateSummary(data.items || []);
        return;
      }

      updateSummary(data.items);
      elList.innerHTML = data.items.map(renderAdItem).join('');
      bindAdDetailButtons();
    }catch(err){
      console.error(err);
      elList.innerHTML = `<p class="error">Kunde inte hämta briefs. Är <code>/admin/api/ads</code> implementerad?</p>`;
      elLbl.textContent = '';
      elSt.textContent  = 'Fel';
    }
  }

  function renderAdItem(it){
    const ans = extractAnswers(it);
    const preview = esc(answersPreview(ans));
    const platform = String(it.platform || '-').toLowerCase();
    const category = it.category || 'ads';
    
    // Category-specific rendering
    let categoryBadge = '';
    let categoryContent = '';
    
    switch (category) {
      case 'ai-studio':
        categoryBadge = '<span class="badge orange">AI Studio</span>';
        if (it.aiStudioData) {
          categoryContent = `
            <div class="meta" style="margin-top:.25rem">
              <strong>Typ:</strong> ${esc(it.aiStudioData.generationType || 'Okänt')}
            </div>
            ${it.aiStudioData.generatedImages?.length ? `
              <div class="meta" style="margin-top:.25rem">
                <strong>Genererade bilder:</strong> ${it.aiStudioData.generatedImages.length} st
              </div>
            ` : ''}
            ${it.aiStudioData.generatedPDFs?.length ? `
              <div class="meta" style="margin-top:.25rem">
                <strong>Genererade PDFs:</strong> ${it.aiStudioData.generatedPDFs.length} st
              </div>
            ` : ''}
          `;
        }
        break;
      case 'radgivning':
        categoryBadge = '<span class="badge blue">Rådgivning</span>';
        if (it.radgivningData) {
          categoryContent = `
            <div class="meta" style="margin-top:.25rem">
              <strong>Frågor:</strong> ${it.radgivningData.questions?.length || 0} st
            </div>
            <div class="meta" style="margin-top:.25rem">
              <strong>Prioritet:</strong> ${esc(it.radgivningData.priority || 'medium')}
            </div>
          `;
        }
        break;
      default:
        categoryBadge = '<span class="badge green">Ads</span>';
        break;
    }

    const idBtn = it._id
      ? `<button class="btn btn-detail" data-id="${esc(it._id)}">Visa detalj</button>`
      : `<span class="badge gray">Ingen detalj (legacy)</span>`;

    const tenantName = it.tenantId || it.tenant || 'Okänt företag';
    const objectId = it.userId || it.objectId || it.meta?.userId || it._id || 'Ingen Object ID';
    const userLabel = `${esc(tenantName)} (${esc(objectId)})`;

    return `
      <div class="card">
        <div class="row">
          <div>
            <div class="badges">${categoryBadge} ${platform !== '-' ? `<span class="badge">${esc(platform)}</span>` : ''}</div>
            <h3 style="margin:.35rem 0 .15rem 0">${esc(userLabel)}</h3>
            <div class="meta">Skapad: ${dse(it.createdAt)}</div>
          </div>
          <div class="platforms" title="Plattform">${iconFor(platform)}</div>
        </div>

        <div class="meta" style="margin-top:.4rem">${preview || '<span class="meta">–</span>'}</div>
        ${it.userEmail ? `<div class="meta" style="margin-top:.25rem">E-post: ${esc(it.userEmail)}</div>` : ''}
        ${categoryContent}

        <details>
          <summary>Visa fälten</summary>
          ${renderAnswersTable(ans)}
        </details>

        <div style="margin-top:.5rem">${idBtn}</div>
      </div>
    `;
  }

  function bindAdDetailButtons(){
    document.querySelectorAll('.btn-detail').forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        const id = e.currentTarget.getAttribute('data-id');
        if (!id) return;
        try{
          const res = await fetch('/api/admin/ads/'+encodeURIComponent(id), { credentials:'include' });
          if (!res.ok) throw new Error('GET /admin/api/ads/:id '+res.status);
          const d = await res.json();
          alert(renderDoc(d)); // TODO: byt gärna till modal
        }catch(err){
          alert('Kunde inte hämta detalj: '+err.message);
        }
      });
    });
  }

  function renderDoc(d){
    const ans = extractAnswers(d);
    const hdr = [
      `category: ${d.category ?? '-'}`,
      `platform: ${d.platform ?? '-'}`,
      `tenantId: ${d.tenantId ?? '-'}`,
      `createdAt: ${dse(d.createdAt)}`
    ].join('\n');
    const kv = Object.entries(ans).map(([k,v]) => `${k}: ${typeof v==='string'? v : JSON.stringify(v)}`).join('\n');
    return `${hdr}\n---\n${kv}`;
  }

  // Enhanced summary update function
  function updateSummary(items) {
    const counts = {
      ads: 0,
      aiStudio: 0,
      radgivning: 0
    };
    
    items.forEach(item => {
      const category = item.category || 'ads';
      if (counts.hasOwnProperty(category)) {
        counts[category]++;
      }
    });
    
    document.getElementById('sumBriefs').textContent = items.length;
    document.getElementById('sumAds').textContent = counts.ads;
    document.getElementById('sumAIStudio').textContent = counts.aiStudio;
    document.getElementById('sumRadgivning').textContent = counts.radgivning;
    document.getElementById('sumSource').textContent = lastSource;
  }

  // Pager + filter + sort
  document.getElementById('filterBtn').addEventListener('click', ()=>{page=1; loadAds();});
  document.getElementById('prevAds').addEventListener('click', ()=>{ if (page>1){ page--; loadAds(); }});
  document.getElementById('nextAds').addEventListener('click', ()=>{ if (page*limit < lastTotal){ page++; loadAds(); }});
  document.getElementById('adsSort').addEventListener('change', (e)=>{adsSortBy=e.target.value; page=1; loadAds();});

  // Set initial sort values
  document.getElementById('adsSort').value = adsSortBy;
  
  // Check admin session before initializing
  fetch("/api/admin/me", { credentials: "include" })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        // Admin is logged in, initialize the page
        loadAds();
      } else {
        // Not logged in, redirect to login
        window.location.href = "/login.html";
      }
    })
    .catch(err => {
      console.error('Session check failed:', err);
      window.location.href = "/login.html";
    });
</script>

</body>
</html>