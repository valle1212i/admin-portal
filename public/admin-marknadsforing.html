<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin ‚Äì Marknadsf√∂ring</title>
  <link rel="stylesheet" href="css/admin-marknadsforing.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  <style>
    :root{--bd:#e5e7eb;--muted:#6b7280}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f8fafc;color:#0f172a;margin:0}
    .layout{display:grid;grid-template-columns:220px 1fr;min-height:100vh}
    .sidebar{padding:16px;border-right:1px solid var(--bd);background:#fff}
    .sidebar h2{margin:.25rem 0 1rem 0}
    .nav{list-style:none;margin:0;padding:0}
    .nav li{margin:.25rem 0}
    .nav a{display:block;padding:.5rem .65rem;border-radius:.5rem;color:#111827;text-decoration:none}
    .nav .active a,.nav a:hover{background:#eef2ff;color:#3730a3}
    main{padding:20px}
    h1{margin:.25rem 0 1rem 0}
    .toolbar{display:flex;flex-wrap:wrap;gap:.5rem;margin-bottom:1rem}
    .toolbar .pill{border:1px solid var(--bd);padding:.35rem .6rem;border-radius:999px;background:#fff;font-size:.9rem}
    .toolbar input[type="search"], .toolbar input[type="date"], .toolbar select{
      padding:.5rem .65rem;border:1px solid var(--bd);border-radius:.55rem;background:#fff
    }
    .toolbar .btn{padding:.5rem .75rem;border:1px solid var(--bd);background:#fff;border-radius:.55rem;cursor:pointer}
    .status{font-size:.9rem;color:var(--muted)}
    .grid{display:grid;gap:12px}
    .card{background:#fff;border:1px solid var(--bd);border-radius:.75rem;padding:12px}
    .row{display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
    .badges{display:flex;gap:.4rem;flex-wrap:wrap}
    .badge{font-size:.72rem;padding:.2rem .45rem;border-radius:.45rem;background:#eef2ff;color:#3730a3}
    .badge.gray{background:#f3f4f6;color:#374151}
    .badge.green{background:#ecfdf5;color:#065f46}
    .badge.orange{background:#fff7ed;color:#9a3412}
    .platforms{display:flex;gap:.35rem;color:#6b7280}
    .platforms i{opacity:.9}
    .meta{color:#6b7280;font-size:.85rem}
    .kv{display:grid;grid-template-columns:160px 1fr;gap:.35rem .75rem;margin:.5rem 0}
    details{border:1px dashed var(--bd);border-radius:.6rem;padding:.5rem;margin-top:.5rem}
    details[open]{background:#fafafa}
    .pager{display:flex;gap:8px;align-items:center;margin-top:8px}
    .pillchip{border:1px solid var(--bd);padding:.25rem .55rem;border-radius:999px;font-size:.8rem}
    .empty{color:var(--muted)}
    .error{color:#b91c1c}
    .split{display:grid;grid-template-columns: minmax(0,2fr) minmax(0,1fr); gap:16px}
    @media (max-width: 1100px){.layout{grid-template-columns:1fr}.split{grid-template-columns:1fr}}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,monospace;font-size:.85rem}
  </style>
</head>
<body>
<div class="layout">
  <aside class="sidebar">
    <h2>Admin</h2>
    <ul class="nav">
      <li><a href="dashboard.html">Dashboard</a></li>
      <li class="active"><a href="admin-marknadsforing.html">Marknadsf√∂ring</a></li>
      <li><a href="customers.html">Kunder</a></li>
      <li><a href="settings.html">Inst√§llningar</a></li>
    </ul>
  </aside>

  <main>
    <h1>üì£ Marknadsf√∂ring</h1>

    <!-- Filter/verktyg f√∂r BRIEFS -->
    <section class="card">
      <div class="toolbar">
        <input id="q" type="search" placeholder="S√∂k i svaren (q1‚Äìq7, extraInfo)‚Ä¶"/>
        <input id="from" type="date"/>
        <input id="to" type="date"/>
        <select id="platform">
          <option value="">Alla plattformar</option>
          <option value="google">Google</option>
          <option value="meta">Meta</option>
          <option value="tiktok">TikTok</option>
          <option value="linkedin">LinkedIn</option>
        </select>
        <button id="filterBtn" class="btn">Filtrera</button>
        <span id="adsStatus" class="status">‚Äì</span>
      </div>

      <div id="adsList" class="grid">
        <p class="meta">Laddar briefs‚Ä¶</p>
      </div>

      <div class="pager">
        <button id="prevAds" class="btn">F√∂reg√•ende</button>
        <span id="adsPageLbl" class="status"></span>
        <button id="nextAds" class="btn">N√§sta</button>
      </div>
    </section>

    <div class="split">
      <!-- SUPPORT-√ñVERSIKT -->
      <section class="card">
        <div class="row">
          <h2 style="margin:.25rem 0">R√•dgivning & Support</h2>
          <span id="supportStatus" class="status">‚Äì</span>
        </div>
        <div class="toolbar">
          <input id="sq" type="search" placeholder="S√∂k i meddelande/etiketter/e-post‚Ä¶"/>
          <select id="sstatus">
            <option value="">Alla statusar</option>
            <option value="open">√ñppna</option>
            <option value="closed">St√§ngda</option>
          </select>
          <input id="sfrom" type="date"/>
          <input id="sto" type="date"/>
          <button id="sbtn" class="btn">Filtrera</button>
        </div>
        <div id="supportList" class="grid">
          <p class="meta">Laddar support‚Ä¶</p>
        </div>
      </section>

      <!-- LIVE-SUMMOR & H√ÑLSA -->
      <section class="card">
        <h2 style="margin:.25rem 0">Sammanfattning</h2>
        <div id="summaryBox" class="kv">
          <div>Antal briefs</div><div id="sumBriefs">‚Äì</div>
          <div>K√§lla</div><div id="sumSource">‚Äì</div>
          <div>√ñppna √§renden</div><div id="sumOpen">‚Äì</div>
          <div>St√§ngda √§renden</div><div id="sumClosed">‚Äì</div>
          <div>DB-h√§lsa</div><div id="dbHealth" class="mono">‚Äì</div>
        </div>
      </section>
    </div>
  </main>
</div>

<script>
  // === Util ===
  function esc(s){ return String(s ?? '').replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }
  function dse(x){ try{ return new Date(x).toLocaleString('sv-SE'); } catch{ return '‚Äì'; } }
  function short(s, n=160){ s=String(s||''); return s.length>n? s.slice(0,n)+'‚Ä¶' : s; }

  // === State ===
  let page=1, limit=20, lastTotal=0, lastSource='primary';
  let s_last = { open:0, closed:0 };

  // === ADS (briefs) ===
  async function loadAds(){
    const elList = document.getElementById('adsList');
    const elLbl  = document.getElementById('adsPageLbl');
    const elSt   = document.getElementById('adsStatus');

    const q = document.getElementById('q').value.trim();
    const from = document.getElementById('from').value;
    const to   = document.getElementById('to').value;
    const platform = document.getElementById('platform').value;

    const params = new URLSearchParams({ page, limit });
    if (q) params.set('q', q);
    if (platform) params.set('platform', platform);
    if (from) params.set('from', new Date(from).toISOString());
    if (to)   params.set('to', new Date(to).toISOString());

    elList.innerHTML = '<p class="meta">H√§mtar‚Ä¶</p>';

    try{
      const res = await fetch('/api/admin/ads?'+params.toString(), { credentials: 'include' });
      if (!res.ok) throw new Error('GET /api/admin/ads: '+res.status);
      const data = await res.json();

      lastTotal = data.total || 0;
      lastSource = data.source || 'primary';
      elLbl.textContent = `Sida ${data.page} ‚Ä¢ ${data.total} poster`;
      elSt.textContent  = `K√§lla: ${lastSource}`;

      if (!data.items?.length){
        elList.innerHTML = `<p class="empty">Inga briefs hittades.</p>`;
        document.getElementById('sumBriefs').textContent = '0';
        document.getElementById('sumSource').textContent = lastSource;
        return;
      }

      document.getElementById('sumBriefs').textContent = data.total;
      document.getElementById('sumSource').textContent = lastSource;

      elList.innerHTML = data.items.map(renderAdItem).join('');
      bindAdDetailButtons();
    }catch(err){
      console.error(err);
      elList.innerHTML = `<p class="error">‚õîÔ∏è Kunde inte h√§mta briefs. Har du lagt till <code>/api/admin/ads</code> i servern?</p>`;
      elLbl.textContent = '';
      elSt.textContent  = 'Fel';
    }
  }

  function renderAdItem(it){
    const isFallback = !!it._fallback;
    const sourceBadge = `<span class="badge ${isFallback?'orange':'green'}">${isFallback?'fallback':'primary'}</span>`;
    const idBtn = it._id ? `<button class="btn btn-detail" data-id="${esc(it._id)}">Visa detalj</button>` : `<span class="badge gray">Ingen detalj (legacy)</span>`;

    const lines = ['q1','q2','q3','q4','q5','q6','q7'].map(k => it[k]).filter(Boolean);
    const preview = esc(short(lines.join(' | ')));

    return `
      <div class="card">
        <div class="row">
          <div>
            <div class="badges">${sourceBadge} <span class="badge">${esc(it.platform||'-')}</span></div>
            <h3 style="margin:.35rem 0 .15rem 0">${esc(it.userEmail || it.userId || 'Ok√§nd anv√§ndare')}</h3>
            <div class="meta">Skapad: ${dse(it.createdAt)}</div>
          </div>
          <div class="platforms" title="Plattform">${iconFor(it.platform)}</div>
        </div>
        <div class="meta" style="margin-top:.4rem">${preview || '<span class="meta">‚Äì</span>'}</div>
        <details>
          <summary>Visa f√§lten</summary>
          <div class="kv">
            ${['q1','q2','q3','q4','q5','q6','q7','extraInfo'].map(k=>`<div>${k.toUpperCase()}</div><div>${esc(it[k]||'')}</div>`).join('')}
          </div>
        </details>
        <div style="margin-top:.5rem">${idBtn}</div>
      </div>
    `;
  }

  function iconFor(p){
    const map = { google:'fa-google', meta:'fa-facebook', tiktok:'fa-tiktok', linkedin:'fa-linkedin' };
    const i = map[p] || 'fa-bullhorn';
    return `<i class="fa-brands ${i}"></i>`;
  }

  function bindAdDetailButtons(){
    document.querySelectorAll('.btn-detail').forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        const id = e.currentTarget.getAttribute('data-id');
        if (!id) return;
        try{
          const res = await fetch('/api/admin/ads/'+encodeURIComponent(id), { credentials:'include' });
          if (!res.ok) throw new Error('GET /api/admin/ads/:id '+res.status);
          const d = await res.json();
          alert(renderDoc(d)); // byt g√§rna mot modal
        }catch(err){
          alert('Kunde inte h√§mta detalj: '+err.message);
        }
      });
    });
  }

  function renderDoc(d){
    const fields = ['platform','createdAt','q1','q2','q3','q4','q5','q6','q7','extraInfo'];
    return fields.map(f => `${f}: ${f==='createdAt'? dse(d[f]) : (d[f]??'')}`).join('\n');
  }

  // Pager
  document.getElementById('filterBtn').addEventListener('click', ()=>{page=1; loadAds();});
  document.getElementById('prevAds').addEventListener('click', ()=>{ if (page>1){ page--; loadAds(); }});
  document.getElementById('nextAds').addEventListener('click', ()=>{ if (page*limit < lastTotal){ page++; loadAds(); }});

  // === SUPPORT ===
  async function loadSupport(){
    const el = document.getElementById('supportList');
    const st = document.getElementById('supportStatus');
    const sq = document.getElementById('sq').value.trim();
    const sstatus = document.getElementById('sstatus').value;
    const sfrom = document.getElementById('sfrom').value;
    const sto   = document.getElementById('sto').value;

    const params = new URLSearchParams({ page:1, limit:200 });
    if (sq) params.set('q', sq);
    if (sstatus) params.set('status', sstatus);
    if (sfrom) params.set('from', new Date(sfrom).toISOString());
    if (sto)   params.set('to', new Date(sto).toISOString());

    el.innerHTML = '<p class="meta">H√§mtar‚Ä¶</p>';

    try{
      const res = await fetch('/api/admin/support?'+params.toString(), { credentials:'include' });
      if (!res.ok) throw new Error('GET /api/admin/support: '+res.status);
      const data = await res.json();

      if (!data.items?.length){
        el.innerHTML = `<p class="empty">Inga √§renden hittades.</p>`;
        st.textContent = '0 √§renden';
        s_last = { open:0, closed:0 };
        updateSummary();
        return;
      }

      // summera statusar
      const open = data.items.filter(t=>String(t.status).toLowerCase()==='open').length;
      const closed = data.items.filter(t=>String(t.status).toLowerCase()==='closed').length;
      s_last = { open, closed };
      st.textContent = `${data.total} √§renden (√∂ppna: ${open}, st√§ngda: ${closed})`;
      updateSummary();

      el.innerHTML = data.items.map(renderTicket).join('');
    }catch(err){
      console.error(err);
      el.innerHTML = `<p class="error">‚õîÔ∏è Kunde inte h√§mta support. Har du lagt till <code>/api/admin/support</code> i servern?</p>`;
      st.textContent = 'Fel';
      s_last = { open:0, closed:0 };
      updateSummary();
    }
  }

  function renderTicket(t){
    const b = `<span class="badge ${t.status==='open'?'green':'gray'}">${esc(t.status)}</span>`;
    return `
      <div class="card">
        <div class="row">
          <div>
            <div class="badges">${b}</div>
            <strong>${esc(t.customerEmail || 'ok√§nd kund')}</strong>
            <div class="meta">${dse(t.createdAt)}</div>
          </div>
        </div>
        <div class="meta" style="margin-top:.25rem">${esc(short(t.message||'',180))}</div>
        ${t.tags?.length ? `<div class="meta" style="margin-top:.25rem">Taggar: ${t.tags.map(esc).join(', ')}</div>` : ''}
      </div>
    `;
  }

  // === SUMMARY & HEALTH ===
  async function health(){
    try{
      const res = await fetch('/_health/db', { credentials:'include' });
      const j = await res.json();
      document.getElementById('dbHealth').textContent = JSON.stringify(j);
    }catch(e){
      document.getElementById('dbHealth').textContent = 'N/A';
    }
  }
  function updateSummary(){
    document.getElementById('sumOpen').textContent = s_last.open;
    document.getElementById('sumClosed').textContent = s_last.closed;
  }

  // === Init ===
  document.getElementById('sbtn').addEventListener('click', loadSupport);
  loadAds();
  loadSupport();
  health();
</script>
</body>
</html>
